<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoRanker - Strictly Host Control</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p1: #6366f1; --p2: #ec4899; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #22c55e; --near: #eab308; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 1rem; min-height: 100vh; margin: 0; }
        .container { max-width: 480px; width: 100%; background: var(--card); padding: 1.5rem; border-radius: 28px; text-align: center; align-self: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        .role-banner { background: rgba(99, 102, 241, 0.2); padding: 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; border: 1px solid var(--p1); }
        .role-chooser { color: var(--p2); border-color: var(--p2); background: rgba(236, 72, 153, 0.1); }
        .role-guesser { color: var(--p1); border-color: var(--p1); background: rgba(99, 102, 241, 0.1); }

        #rank-list { list-style: none; padding: 0; margin: 1.5rem 0; }
        .rank-item { background: #334155; margin-bottom: 10px; padding: 1rem; border-radius: 14px; cursor: grab; display: flex; align-items: center; text-align: left; font-size: 0.95rem; border: 2px solid transparent; }
        .rank-item.dragging { opacity: 0.4; border-color: var(--p1); }

        .comparison-stack { margin-top: 20px; display: flex; flex-direction: column; gap: 8px; text-align: left; }
        .res-item { display: flex; align-items: center; background: #0f172a; padding: 12px; border-radius: 16px; border-left: 5px solid #475569; }
        .res-item.perfect { border-left-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .res-item.close { border-left-color: var(--near); background: rgba(234, 179, 8, 0.1); }
        .res-rank { font-weight: 800; width: 30px; color: #94a3b8; }
        .res-content { flex-grow: 1; padding-left: 10px; }

        button { width: 100%; padding: 1.1rem; border-radius: 14px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .btn-main { background: var(--p1); color: white; }
        .btn-wait { background: #0f172a !important; color: #475569; border: 1px solid #334155 !important; cursor: not-allowed; }
        
        select, input { width: 100%; padding: 12px; border-radius: 12px; background: #0f172a; color: white; border: 1px solid #475569; margin-bottom: 15px; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-start">
        <h1>DuoRanker</h1>
        <select id="mode-select">
            <option value="romance">30 Romance Q&A</option>
            <option value="personal">30 Personal Q&A</option>
        </select>
        <select id="length-select">
            <option value="10">10 Questions</option>
            <option value="20">20 Questions</option>
            <option value="30">30 Questions</option>
        </select>
        <button class="btn-main" onclick="startHost()">Host Game</button>
        <div style="margin:15px; color:#475569;">— OR —</div>
        <input type="text" id="join-id" placeholder="Code">
        <button style="background:#334155; color:white;" onclick="startJoin()">Join Partner</button>
    </div>

    <div id="screen-waiting" class="hidden">
        <h3>Room Code</h3>
        <h1 id="my-id-display" style="font-size: 3.5rem; color: var(--p1); margin: 0;">----</h1>
    </div>

    <div id="screen-game" class="hidden">
        <div id="role-indicator" class="role-banner">Your Role</div>
        <h2 id="question-text">...</h2>
        <div id="rank-list"></div>
        <button id="submit-btn" class="btn-main" onclick="sendOrder()">Lock Order</button>
        <p id="round-counter" style="font-size: 0.8rem; color: #64748b; margin-top: 10px;"></p>
    </div>

    <div id="screen-results" class="hidden">
        <div id="score-display" style="font-size: 4rem; font-weight: 900; color: var(--p2);">0%</div>
        <div class="comparison-stack" id="full-reveal"></div>
        <div id="host-control-area" style="margin-top: 20px;">
            </div>
    </div>

    <div id="screen-final" class="hidden">
        <h1>Game Over</h1>
        <div id="final-score" style="font-size: 5rem; font-weight: 900; color: var(--success);">0%</div>
        <button class="btn-main" onclick="location.reload()">Back to Home</button>
    </div>
</div>

<script>
    // Q&A Bank (Truncated here, use your previous full 60)
    const questionBank = {
        romance: [
            { q: "Ideal First Date?", opts: ["Fancy Dinner", "Coffee Shop", "Amusement Park", "Starlit Picnic", "Arcade"] },
            { q: "Best Gesture?", opts: ["Love Letter", "Surprise Trip", "Cooking", "PDA", "Small Gifts"] },
            // Add other 28...
        ],
        personal: [
            { q: "Life Phase?", opts: ["Childhood", "High School", "Young Adult", "Career", "Retirement"] },
            { q: "Biggest Fear?", opts: ["Alone", "Failure", "Public Speaking", "Pain", "Control"] },
            // Add other 28...
        ]
    };

    let peer, conn, myRole, currentIdx = 0, mode = 'romance', maxRounds = 10;
    let truth = null, locked = false, totalScore = 0;

    function startHost() {
        mode = document.getElementById('mode-select').value;
        maxRounds = parseInt(document.getElementById('length-select').value);
        peer = new Peer(Math.floor(1000 + Math.random() * 9000).toString());
        myRole = 'host';
        peer.on('open', (id) => { document.getElementById('my-id-display').innerText = id; show('screen-waiting'); });
        peer.on('connection', (c) => { conn = c; setupConn(); });
    }

    function startJoin() {
        peer = new Peer(); myRole = 'guest';
        peer.on('open', () => { 
            conn = peer.connect(document.getElementById('join-id').value); 
            setupConn(); 
        });
    }

    function setupConn() {
        conn.on('open', () => { 
            if(myRole === 'host') conn.send({type:'INIT', mode, maxRounds});
            show('screen-game'); startRound(); 
        });
        conn.on('data', (d) => {
            if(d.type==='INIT') { mode = d.mode; maxRounds = d.maxRounds; startRound(); }
            if(d.type==='TRUTH') { truth = d.order; updateUI(); }
            if(d.type==='GUESS') { revealAll(truth, d.order); }
            if(d.type==='NEXT') { 
                currentIdx++; 
                if(currentIdx >= maxRounds) showFinalScore();
                else startRound(); 
            }
        });
    }

    function startRound() {
        show('screen-game'); truth = null; locked = false;
        const qSet = questionBank[mode];
        const q = qSet[currentIdx % qSet.length];
        document.getElementById('question-text').innerText = q.q;
        document.getElementById('round-counter').innerText = `Round ${currentIdx + 1} of ${maxRounds}`;
        renderList(q.opts);
        updateUI();
    }

    function updateUI() {
        const roleEl = document.getElementById('role-indicator');
        const btn = document.getElementById('submit-btn');
        const isChooser = (currentIdx % 2 === 0 && myRole === 'host') || (currentIdx % 2 !== 0 && myRole === 'guest');

        if(isChooser) {
            roleEl.innerText = "YOUR ROLE: CHOOSER (Set the Truth)";
            roleEl.className = "role-banner role-chooser";
            btn.classList.remove('hidden');
        } else if (!truth) {
            roleEl.innerText = "YOUR ROLE: GUESSER (Wait for Partner)";
            roleEl.className = "role-banner role-guesser";
            btn.classList.add('hidden');
        } else {
            roleEl.innerText = "YOUR ROLE: GUESSER (Guess Now!)";
            roleEl.className = "role-banner role-guesser";
            btn.classList.remove('hidden');
        }

        btn.innerText = locked ? "✓ ORDER LOCKED" : "LOCK MY ORDER";
        btn.disabled = locked;
        if(locked) btn.classList.add('btn-wait'); else btn.classList.remove('btn-wait');
    }

    function sendOrder() {
        const order = [...document.querySelectorAll('.rank-item')].map(li => li.innerText);
        locked = true; updateUI();
        if(!truth) { conn.send({type:'TRUTH', order}); truth = order; }
        else { conn.send({type:'GUESS', order}); revealAll(truth, order); }
    }

    function revealAll(truthArr, guessArr) {
        show('screen-results');
        const stack = document.getElementById('full-reveal');
        stack.innerHTML = "";
        let pts = 0;

        truthArr.forEach((item, i) => {
            const gIdx = guessArr.indexOf(item);
            const dist = Math.abs(i - gIdx);
            if(dist === 0) pts += 2; else if(dist === 1) pts += 1;
            const div = document.createElement('div');
            div.className = `res-item ${dist === 0 ? 'perfect' : (dist === 1 ? 'close' : '')}`;
            div.innerHTML = `<div class="res-rank">#${i + 1}</div><div class="res-content"><b>${item}</b><br><small>Guessed #${gIdx+1}</small></div>`;
            stack.appendChild(div);
        });
        
        const roundScore = Math.round((pts/10)*100);
        totalScore += roundScore;
        document.getElementById('score-display').innerText = roundScore + "%";
        
        const controlArea = document.getElementById('host-control-area');
        if (myRole === 'host') {
            controlArea.innerHTML = `<button class="btn-main" onclick="triggerHostNext()">${currentIdx + 1 >= maxRounds ? 'Finish Game' : 'Next Question →'}</button>`;
        } else {
            controlArea.innerHTML = `<button class="btn-wait" disabled>Waiting for Host...</button>`;
        }
    }

    // STRICT HOST-ONLY FUNCTION
    function triggerHostNext() {
        if (myRole !== 'host') return; // Double protection
        
        if (currentIdx + 1 >= maxRounds) {
            conn.send({type: 'NEXT'}); // Tell guest to move to final
            showFinalScore();
        } else {
            currentIdx++;
            conn.send({type: 'NEXT'}); // Tell guest to move to next round
            startRound();
        }
    }

    function showFinalScore() {
        show('screen-final');
        document.getElementById('final-score').innerText = Math.round(totalScore / maxRounds) + "%";
    }

    function renderList(opts) {
        const list = document.getElementById('rank-list');
        list.innerHTML = "";
        opts.sort(()=>Math.random()-0.5).forEach(t => {
            const li = document.createElement('div');
            li.className = 'rank-item'; li.draggable = true; li.innerText = t;
            li.addEventListener('dragstart', () => { if(!locked) li.classList.add('dragging') });
            li.addEventListener('dragend', () => li.classList.remove('dragging'));
            list.appendChild(li);
        });
    }

    document.getElementById('rank-list').addEventListener('dragover', e => {
        if(locked) return;
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        const list = document.getElementById('rank-list');
        const after = [...list.querySelectorAll('.rank-item:not(.dragging)')].find(el => e.clientY <= el.getBoundingClientRect().top + el.height/2);
        list.insertBefore(dragging, after || null);
    });

    function show(id) { document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
</script>
</body>
</html>
