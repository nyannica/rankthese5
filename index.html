<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuoRanker: Soulmates</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            --p1: #be123c; /* Rose Red */
            --p2: #701a75; /* Deep Velvet */
            --bg: #0a0505; /* Obsidian */
            --card: #1a0b0b; /* Dark Chocolate/Wine */
            --text: #ffe4e6; /* Soft Pink Text */
            --success: #f43f5e; /* Bright Rose */
            --near: #fb7185; /* Soft Petal */
            --skip: #4c0519; /* Dried Rose */
            --accent: #fda4af; 
        }
        
        body { 
            margin:0; 
            font-family: 'Georgia', serif; 
            background: var(--bg); 
            background-image: radial-gradient(circle at center, #2d0606 0%, #0a0505 100%);
            color:var(--text); 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            min-height:100vh; 
            padding:1rem; 
            overflow:hidden;
            touch-action: none; 
        }

        body::before {
            content: "‚ô•";
            position: fixed;
            top: -10%;
            left: 10%;
            font-size: 2rem;
            color: rgba(190, 18, 60, 0.1);
            animation: float 15s infinite linear;
            z-index: -1;
        }

        @keyframes float {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        .container { 
            max-width:480px;
            width:100%; 
            background:var(--card); 
            padding:2rem; 
            border-radius:32px; 
            text-align:center; 
            box-shadow: 0 0 30px rgba(190, 18, 60, 0.2), inset 0 0 15px rgba(0,0,0,0.5);
            border: 1px solid rgba(190, 18, 60, 0.3);
            max-height:95vh; 
            overflow-y:auto; 
            position: relative;
        }

        h1 { font-style: italic; color: var(--accent); text-shadow: 0 0 10px rgba(244, 63, 94, 0.5); }
        .hidden { display:none !important; }

        button { 
            width:100%;
            padding:1.1rem; 
            border:none; 
            border-radius:100px; 
            font-weight:bold; 
            cursor:pointer; 
            margin-top:12px; 
            transition:0.3s; 
            font-size:1rem; 
            color:white; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover { filter: brightness(1.2); transform: translateY(-2px); }
        button:disabled { opacity: 0.4; transform: none; }

        .btn-main { background: linear-gradient(45deg, var(--p1), #881337); box-shadow: 0 4px 15px rgba(190, 18, 60, 0.4); }
        .btn-alt { background: linear-gradient(45deg, var(--p2), #4a044e); }
        .btn-outline { background: transparent; border: 1px solid var(--p1); color: var(--accent); }
        .btn-skip { background: transparent; color: var(--skip); border: 1px solid var(--skip); font-size: 0.7rem; margin-top: 20px; }

        input, select { 
            width:100%;
            padding:14px; 
            margin-bottom:12px; 
            border-radius:15px; 
            background:#000000; 
            color:var(--accent); 
            border:1px solid #4c0519; 
            box-sizing:border-box; 
            font-size:1rem;
        }

        #rank-list { margin:1.5rem 0; display:flex; flex-direction:column; gap:10px; }
        
        .rank-item { 
            background: rgba(76, 5, 25, 0.3);
            padding:16px; 
            border-radius:15px; 
            cursor:grab; 
            text-align:left; 
            user-select:none; 
            display:flex; 
            align-items:center; 
            border:1px solid rgba(190, 18, 60, 0.2); 
            font-size:0.95rem;
            touch-action: none; 
            transition: background 0.2s;
        }
        
        .rank-item::before { content:"‚ù§"; margin-right:12px; color: var(--p1); opacity:0.6; font-size: 0.8rem; }
        .rank-item.active { background:var(--p1); border-color: var(--accent); transform: scale(1.05); z-index: 10; }
        .rank-preview { opacity: 0.4; cursor: default; pointer-events: none; border: 1px dashed var(--p1); }
        
        #live-points { 
            background: rgba(0,0,0,0.5);
            padding: 12px; 
            border-radius: 50px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-around; 
            border: 1px solid var(--p1); 
            font-size: 0.8rem;
            font-weight: bold;
        }

        .result-row { 
            display: flex;
            justify-content: space-between; 
            padding: 12px; 
            border-bottom: 1px solid rgba(190, 18, 60, 0.1); 
            font-size: 0.9rem;
        }

        #steal-timer { font-size: 0.75rem; margin-top: 10px; color: var(--accent); font-style: italic; }
        .winner-banner { 
            font-size: 2.2rem;
            margin: 20px 0; 
            color: var(--accent); 
            text-shadow: 0 0 20px var(--p1);
        }
        #status { font-size:0.6rem; color:var(--p1); margin-bottom:5px; text-transform:uppercase; font-weight: bold; letter-spacing: 1px;}
    </style>
</head>
<body>

<div class="container">
    <div id="status">Initializing...</div>
    
    <div id="live-points" class="hidden">
        <span id="p-host-score" style="color:var(--accent)">Host: 0</span>
        <span id="p-guest-score" style="color:var(--p1)">Guest: 0</span>
    </div>

    <div id="screen-start">
        <h1>DuoRanker: <i>Soulmates</i></h1>
        <select id="mode-select" onchange="toggleCustomBtn()">
            <option value="romance">Romance üíñ</option>
            <option value="personal">Compatibility üèπ</option>
            <option value="gaming">Video Games üéÆ</option>
            <option value="travel">Travel & Adventure ‚úàÔ∏è</option>
            <option value="career">Career & Ambition üíº</option>
            <option value="chaos">üî• CHAOS MODE</option>
            <option value="custom">‚úçÔ∏è CUSTOM QUESTIONS</option>
        </select>
        <select id="round-select">
            <option value="5">Blitz (5 Rounds)</option>
            <option value="10" selected>Standard (10 Rounds)</option>
            <option value="20">Marathon (20 Rounds)</option>
        </select>
        <button id="host-btn" class="btn-main" onclick="startHost()" disabled>Loading Bank...</button>
        <input id="join-id" placeholder="Partner Code" type="tel" style="margin-top:15px;">
        <button class="btn-outline" onclick="startJoin()">Join Game</button>
    </div>

    <div id="screen-custom" class="hidden">
        <h1>Create Your Question</h1>
        <input id="custom-q" placeholder="Enter your question...">
        <div id="custom-opts">
            <input class="custom-opt" placeholder="Option 1">
            <input class="custom-opt" placeholder="Option 2">
            <input class="custom-opt" placeholder="Option 3">
            <input class="custom-opt" placeholder="Option 4">
            <input class="custom-opt" placeholder="Option 5">
        </div>
        <button class="btn-main" onclick="saveCustomAndHost()">Start Custom Game</button>
        <button class="btn-outline" onclick="show('screen-start')">Back</button>
    </div>

    <div id="screen-wait" class="hidden">
        <p>Invite your partner</p>
        <h1 id="room-id" style="font-size:3.5rem; color:var(--p1); margin:10px 0;">----</h1>
    </div>

    <div id="screen-game" class="hidden">
        <div id="role-tag" style="font-size:0.7rem; font-weight:900; letter-spacing:1px; margin-bottom:5px;"></div>
        <h2 id="question" style="font-size:1.1rem; margin:10px 0;"></h2>
        <div id="rank-list"></div>
        <button id="submit" class="btn-main" onclick="sendOrder()">Lock My Order</button>
        <button id="skip-btn" class="btn-skip" onclick="requestSkip()">Skip Question ‚è≠Ô∏è</button>
        <p id="round-info" style="font-size:0.7rem; color:var(--near); margin-top:10px;"></p>
    </div>

    <div id="screen-results" class="hidden">
        <h2 id="res-title">The Connection</h2>
        <div id="result-list" style="margin: 15px 0;"></div>
        <div id="controls"></div>
        <div id="steal-timer"></div>
    </div>

    <div id="screen-final" class="hidden">
        <h1>Fate Decided</h1>
        <div class="winner-banner" id="winner-text"></div>
        <div id="final-stats" style="margin-bottom: 20px;"></div>
        <div id="post-game-controls"></div>
        <button class="btn-outline" style="margin-top:20px" onclick="location.reload()">Exit to Menu</button>
    </div>
</div>

<script>
let bank = null; 
let peer, conn, role, idx=0, max=10, mode="romance", truth=null, locked=false;
let scores = { host: 0, guest: 0 }, deck = [], currentDesigner="host";
let stealInterval;

async function initGame() {
    try {
        const response = await fetch('questions.json');
        bank = await response.json();
        document.getElementById("status").innerText = "Ready to Begin";
        const hBtn = document.getElementById("host-btn");
        hBtn.disabled = false;
        hBtn.innerText = "Host Connection";
    } catch (e) {
        document.getElementById("status").innerText = "Error Loading Questions";
        console.error("Could not load questions.json", e);
    }
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function show(id) { 
    document.querySelectorAll(".container > div:not(#status):not(#live-points)").forEach(d => d.classList.add("hidden")); 
    document.getElementById(id).classList.remove("hidden");
}

function toggleCustomBtn() {
    const modeVal = document.getElementById("mode-select").value;
    const hostBtn = document.getElementById("host-btn");
    hostBtn.innerText = (modeVal === "custom") ? "Design Question" : "Host Connection";
}

function startHost() {
    if(!bank) return;
    mode = document.getElementById("mode-select").value;
    
    if(mode === "custom") {
        show("screen-custom");
        return;
    }

    max = parseInt(document.getElementById("round-select").value);
    let pool = (mode === 'chaos') ? [].concat(...Object.values(bank)) : [...bank[mode]];
    deck = shuffle(pool).slice(0, max);
    initPeer();
}

function saveCustomAndHost() {
    const q = document.getElementById("custom-q").value;
    const optInputs = document.querySelectorAll(".custom-opt");
    const opts = Array.from(optInputs).map(i => i.value).filter(v => v.trim() !== "");
    
    if(!q || opts.length < 2) return alert("Please enter a question and at least 2 options!");
    
    deck = [{ q, opts }];
    max = 1; 
    
    if (conn && conn.open) {
        // If already connected, just start the custom game
        conn.send({ type: "START", mode: "custom", max: 1, deck });
        round();
    } else {
        initPeer();
    }
}

function initPeer() {
    peer = new Peer(Math.floor(1000 + Math.random() * 9000) + ""); 
    role = "host";
    peer.on("open", id => { document.getElementById("room-id").innerText = id; show("screen-wait"); });
    peer.on("connection", c => { conn = c; setup(); });
}

function startJoin() {
    peer = new Peer(); role = "guest";
    peer.on("open", () => { 
        const id = document.getElementById("join-id").value;
        if(!id) return alert("Enter a code!");
        conn = peer.connect(id); setup(); 
    });
}

function setup() {
    conn.on("open", () => { 
        document.getElementById("status").innerText = "Connection Live";
        document.getElementById("live-points").classList.remove("hidden");
        if(role === "guest") conn.send({ type: "READY" }); 
    });
    conn.on("data", d => {
        if(d.type === "READY" && role === "host") { conn.send({ type: "START", mode, max, deck }); round(); }
        if(d.type === "START") { mode = d.mode; max = d.max; deck = d.deck; idx = d.i || 0; round(); }
        if(d.type === "TRUTH") { truth = d.order; ui(); render(deck[idx].opts, false); }
        if(d.type === "GUESS") { reveal(truth, d.order); }
        if(d.type === "NEXT") { idx = d.i; (idx >= max) ? showFinalScore() : round(); }
        if(d.type === "SYNC_SCORE") { scores = d.scores; updatePoints(); }
        if(d.type === "STEAL") { 
            clearInterval(stealInterval);
            currentDesigner = (role === "host") ? "guest" : "host"; 
            replay(); 
        }
        if(d.type === "SKIP") { handleSkip(); }
    });
}

function updatePoints() {
    document.getElementById("p-host-score").innerText = `Host: ${scores.host}`;
    document.getElementById("p-guest-score").innerText = `Guest: ${scores.guest}`;
}

function round() {
    truth = null; locked = false;
    currentDesigner = (idx % 2 === 0) ? "host" : "guest";
    replay();
}

function replay() {
    locked = false; 
    const btn = document.getElementById("submit");
    if (btn) {
        btn.disabled = false;
        btn.innerText = "Lock My Order";
        btn.classList.remove("hidden");
    }

    document.getElementById("question").innerText = deck[idx].q;
    document.getElementById("round-info").innerText = `Step ${idx + 1} of ${max}`;
    const isGuesserWaiting = (role !== currentDesigner && !truth);
    render(deck[idx].opts, isGuesserWaiting);
    ui(); show("screen-game");
}

function ui() {
    const isCr = (role === currentDesigner);
    const tag = document.getElementById("role-tag");
    tag.innerText = isCr ? "‚≠ê SET YOUR TRUTH" : (truth ? "üîç GUESS THEIR TRUTH" : "‚åõ PREVIEWING OPTIONS...");
    tag.style.color = isCr ? "var(--accent)" : "var(--p1)";
    document.getElementById("submit").classList.toggle("hidden", !isCr && !truth);
    document.getElementById("skip-btn").classList.toggle("hidden", !isCr && !truth);
}

function render(opts, isPreview) {
    const rl = document.getElementById("rank-list"); rl.innerHTML = "";
    opts.forEach(t => {
        const d = document.createElement("div");
        d.className = "rank-item" + (isPreview ? " rank-preview" : "");
        d.innerText = t;
        rl.appendChild(d);
    });
}

function requestSkip() {
    if(confirm("Abandon this thought? No points awarded.")) {
        conn.send({ type: "SKIP" });
        handleSkip();
    }
}

function handleSkip() {
    if(role === "host") {
        idx++;
        conn.send({type: "NEXT", i: idx});
        (idx >= max) ? showFinalScore() : round();
    } else {
        document.getElementById("status").innerText = "Skipping...";
    }
}

function sendOrder() {
    const btn = document.getElementById("submit");
    btn.innerText = "Order Locked ‚ù§";
    btn.disabled = true;
    const order = [...document.querySelectorAll(".rank-item")].map(x => x.innerText);
    locked = true; 
    if(!truth) { 
        truth = order;
        conn.send({ type: "TRUTH", order }); 
    }
    else { 
        conn.send({ type: "GUESS", order });
        reveal(truth, order); 
    }
}

function reveal(t, g) {
    clearInterval(stealInterval);
    const list = document.getElementById("result-list"); list.innerHTML = "";
    let pts = 0;
    t.forEach((x, i) => {
        const actualPos = g.indexOf(x); const diff = Math.abs(i - actualPos);
        if(diff === 0) pts += 2; else if(diff === 1) pts += 1;
        let div = document.createElement("div"); div.className = "result-row";
        div.innerHTML = `<span>${x}</span><span style="color:${diff===0?'var(--success)':'var(--text)'}">Rank #${actualPos+1}</span>`;
        list.appendChild(div);
    });
    if(role === "host") { 
        scores[(currentDesigner==='host'?'guest':'host')] += pts; 
        conn.send({ type: "SYNC_SCORE", scores });
        updatePoints(); 
    }
    
    const ctrl = document.getElementById("controls"); ctrl.innerHTML = "";
    const timerDisplay = document.getElementById("steal-timer");
    timerDisplay.innerText = "";

    if(role !== currentDesigner) {
        let timeLeft = 5;
        let b = document.createElement("button"); 
        b.className="btn-alt"; b.id="btn-steal-action";
        b.innerText=`üîÑ Steal Turn (${timeLeft}s)`;
        b.onclick = () => { conn.send({type:"STEAL"}); currentDesigner=role; replay(); };
        ctrl.appendChild(b);
        stealInterval = setInterval(() => {
            timeLeft--;
            if(timeLeft > 0) b.innerText = `üîÑ Steal Turn (${timeLeft}s)`;
            else { b.disabled = true; b.innerText = "Time Expired"; clearInterval(stealInterval); }
        }, 1000);
    }

    if(role === "host") {
        let bNext = document.createElement("button"); 
        bNext.className="btn-main";
        bNext.innerText=(idx+1 >= max) ? "Reveal the Bond" : "Next Round";
        bNext.onclick = () => { 
            clearInterval(stealInterval);
            idx++;
            conn.send({type:"NEXT", i:idx}); 
            (idx >= max) ? showFinalScore() : round(); 
        };
        ctrl.appendChild(bNext);
    }
    show("screen-results");
}

function showFinalScore() {
    const winnerText = document.getElementById("winner-text");
    const stats = document.getElementById("final-stats");
    const controls = document.getElementById("post-game-controls");
    controls.innerHTML = "";
    
    let winner = "";
    if(scores.host > scores.guest) winner = "HOST REIGNS ü•Ä";
    else if(scores.guest > scores.host) winner = "GUEST REIGNS ü•Ä";
    else winner = "SOUL BOUND ü§ù";
    
    winnerText.innerText = winner;
    stats.innerHTML = `<p>Host Heart: ${scores.host}</p><p>Guest Heart: ${scores.guest}</p>`;
    
    document.getElementById("live-points").classList.add("hidden");
    show("screen-final");

    if (role === "host") {
        let btnNext = document.createElement("button");
        btnNext.className = "btn-main";
        btnNext.innerText = (mode === "custom") ? "Restart Custom Question" : "Next Round (Same Mode)";
        btnNext.onclick = () => {
            idx = 0;
            if (mode !== "custom") {
                let pool = (mode === 'chaos') ? [].concat(...Object.values(bank)) : [...bank[mode]];
                deck = shuffle(pool).slice(0, max);
            }
            conn.send({ type: "START", mode, max, deck, i: 0 });
            round();
        };
        controls.appendChild(btnNext);

        let btnSwap = document.createElement("button");
        btnSwap.className = "btn-alt";
        btnSwap.innerText = (mode === "custom") ? "Guest Sets Truth First" : "Give Guest Turn 1";
        btnSwap.onclick = () => {
            // For custom mode with 1 question, we use idx=1 to toggle designer to Guest
            // but we must make sure max is set to accommodate the index
            let startIdx = 1;
            let tempMax = (mode === "custom") ? 2 : max; 
            
            // Re-copy question for custom swap so index 1 exists
            if (mode === "custom") {
                deck = [deck[0], deck[0]];
            } else {
                let pool = (mode === 'chaos') ? [].concat(...Object.values(bank)) : [...bank[mode]];
                deck = shuffle(pool).slice(0, max);
            }

            conn.send({ type: "START", mode, max: tempMax, deck, i: startIdx });
            idx = startIdx;
            max = tempMax;
            round();
        };
        controls.appendChild(btnSwap);

        if (mode === "custom") {
            let btnNew = document.createElement("button");
            btnNew.className = "btn-outline";
            btnNew.innerText = "Design New Question";
            btnNew.onclick = () => show("screen-custom");
            controls.appendChild(btnNew);
        }
    } else {
        controls.innerHTML = "<p style='font-size:0.8rem; opacity:0.6;'>Waiting for Host...</p>";
    }
}

// DRAG AND DROP LOGIC
let active = null;
document.addEventListener("pointerdown", e => { 
    const item = e.target.closest(".rank-item");
    if(item && !item.classList.contains("rank-preview") && !locked) { 
        active = item; 
        active.classList.add("active"); 
        active.setPointerCapture(e.pointerId);
    } 
});

document.addEventListener("pointermove", e => {
    if(!active) return;
    let target = document.elementFromPoint(e.clientX, e.clientY);
    if(target) {
        let itemUnder = target.closest(".rank-item");
        if(itemUnder && itemUnder !== active && !itemUnder.classList.contains("rank-preview")) {
            let rect = itemUnder.getBoundingClientRect();
            let next = (e.clientY > rect.top + rect.height / 2);
            if(next) itemUnder.after(active);
            else itemUnder.before(active);
        }
    }
});

document.addEventListener("pointerup", e => { 
    if(active) {
        active.releasePointerCapture(e.pointerId);
        active.classList.remove("active"); 
        active = null; 
    }
});

initGame();
</script>
</body>
</html>
