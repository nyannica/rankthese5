<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuoRanker: Dark Valentine</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            /* Dark Valentine Palette */
            --p1: #f43f5e;    /* Radiant Rose */
            --p2: #881337;    /* Deep Wine */
            --bg: #0f0507;    /* Obsidian Red */
            --card: #1c0a0e;  /* Dark Cocoa/Rose */
            --text: #fff1f2;  /* Soft Blush White */
            --success: #fb7185; /* Glowing Pink */
            --near: #9f1239;  /* Crimson */
            --skip: #4c0519;  /* Dark Burgundy */
            --border: #fb718533; /* Translucent Rose Border */
        }

        body { 
            margin:0; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            /* Subtle dark heart-grid pattern */
            background-image: radial-gradient(#310a12 1.5px, transparent 1.5px);
            background-size: 30px 30px;
            color: var(--text); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 1rem; 
            overflow: hidden; 
            touch-action: none; 
        }

        .container { 
            max-width: 480px; 
            width: 100%; 
            background: var(--card); 
            padding: 2rem; 
            border-radius: 32px; 
            text-align: center; 
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 20px rgba(244, 63, 94, 0.1); 
            max-height: 95vh; 
            overflow-y: auto; 
            position: relative; 
            border: 1px solid var(--border);
        }

        .hidden { display:none !important; }

        button { 
            width: 100%; 
            padding: 1.1rem; 
            border: none; 
            border-radius: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 10px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            font-size: 1rem; 
            color: white; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(244, 63, 94, 0.4); }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-main { background: linear-gradient(135deg, var(--p1), #be123c); }
        .btn-alt { background: var(--p2); border: 1px solid var(--p1); }
        .btn-outline { background: transparent; border: 2px solid var(--p2); color: var(--p1); }
        .btn-skip { background: var(--skip); margin-top: 15px; font-size: 0.8rem; padding: 0.7rem; color: var(--p1); border: 1px solid #ffffff11; }

        input, select { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 12px; 
            border-radius: 14px; 
            background: #00000044; 
            color: white; 
            border: 1px solid var(--border); 
            box-sizing: border-box; 
            font-size: 1rem; 
            outline: none;
        }
        input:focus { border-color: var(--p1); }

        #rank-list { position: relative; margin: 1.5rem 0; display: flex; flex-direction: column; gap: 12px; }

        .rank-item { 
            background: #2d1116; 
            color: var(--text);
            padding: 16px; 
            border-radius: 18px; 
            cursor: grab; 
            text-align: left; 
            user-select: none; 
            display: flex; 
            align-items: center; 
            border: 1px solid var(--border); 
            font-size: 1rem;
            touch-action: none; 
            transition: background 0.2s, transform 0.2s;
        }

        .rank-item::before { content: "‚ù§"; margin-right: 15px; color: var(--p1); filter: drop-shadow(0 0 5px var(--p1)); }
        
        .rank-item.active { 
            background: var(--p2); 
            border-color: var(--p1); 
            transform: scale(1.05); 
            z-index: 10; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5), 0 0 15px rgba(244, 63, 94, 0.3); 
        }

        .rank-preview { opacity: 0.3; cursor: default; pointer-events: none; border: 2px dashed var(--p2); background: transparent; }

        #live-points { 
            background: #00000055; 
            padding: 14px; 
            border-radius: 20px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-around; 
            font-weight: bold; 
            border: 1px solid var(--border); 
            font-size: 0.9rem; 
            backdrop-filter: blur(5px);
        }

        .result-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 14px; 
            border-bottom: 1px solid #ffffff08; 
            font-size: 0.95rem; 
        }

        #steal-timer { font-size: 0.8rem; margin-top: 8px; color: var(--p1); font-weight: bold; text-shadow: 0 0 10px var(--p1); }
        .winner-banner { font-size: 2.5rem; margin: 25px 0; color: var(--p1); text-shadow: 0 0 20px var(--p1); font-weight: 900; }
        
        /* Custom Scrollbar */
        .container::-webkit-scrollbar { width: 5px; }
        .container::-webkit-scrollbar-track { background: transparent; }
        .container::-webkit-scrollbar-thumb { background: var(--p2); border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="status" style="font-size:0.65rem; color:var(--p1); margin-bottom:10px; text-transform:uppercase; font-weight: 900; letter-spacing: 2px;">Establishing Connection...</div>
    
    <div id="live-points" class="hidden">
        <span id="p-host-score" style="color:var(--p1)">Host: 0</span>
        <span id="p-guest-score" style="color:var(--success)">Guest: 0</span>
    </div>

    <div id="screen-start">
        <h1 style="color: var(--p1); margin: 0 0 20px 0; text-shadow: 0 0 15px rgba(244,63,94,0.4);">DUO RANKER ‚ù§</h1>
        <select id="mode-select">
            <option value="gaming">Video Games üéÆ</option>
            <option value="travel">Travel & Adventure ‚úàÔ∏è</option>
            <option value="career">Career & Ambition üíº</option>
            <option value="romance">Romance üíñ</option>
            <option value="personal">Personal Traits üß†</option>
            <option value="chaos">üî• CHAOS MODE</option>
        </select>
        <select id="round-select">
            <option value="5">Blitz (5 Rounds)</option>
            <option value="10" selected>Standard (10 Rounds)</option>
            <option value="20">Marathon (20 Rounds)</option>
        </select>
        <button id="host-btn" class="btn-main" onclick="startHost()" disabled>Syncing Data...</button>
        <div style="margin: 20px 0; height: 1px; background: var(--border);"></div>
        <input id="join-id" placeholder="Enter Partner's Code" type="tel">
        <button class="btn-outline" onclick="startJoin()">Join Match</button>
    </div>

    <div id="screen-wait" class="hidden">
        <p style="opacity: 0.7;">Your Room Code</p>
        <h1 id="room-id" style="font-size:4rem; color:var(--p1); margin:15px 0; letter-spacing: 5px; text-shadow: 0 0 20px var(--p1);">----</h1>
        <p style="font-size: 0.8rem; color: var(--success);">Waiting for your partner to join...</p>
    </div>

    <div id="screen-game" class="hidden">
        <div id="role-tag" style="font-size:0.75rem; font-weight:900; letter-spacing:2px; margin-bottom:10px;"></div>
        <h2 id="question" style="font-size:1.3rem; margin:15px 0; color: var(--text); line-height: 1.4;"></h2>
        <div id="rank-list"></div>
        <button id="submit" class="btn-main" onclick="sendOrder()">Confirm Order</button>
        <button id="skip-btn" class="btn-skip" onclick="requestSkip()">Skip This Question</button>
        <p id="round-info" style="font-size:0.75rem; opacity:0.5; margin-top:15px;"></p>
    </div>

    <div id="screen-results" class="hidden">
        <h2 id="res-title" style="color: var(--p1);">Match Precision</h2>
        <div id="result-list" style="margin: 20px 0; background: #00000033; border-radius: 15px;"></div>
        <div id="controls"></div>
        <div id="steal-timer"></div>
    </div>

    <div id="screen-final" class="hidden">
        <h1 style="color: var(--p1);">FINALE</h1>
        <div class="winner-banner" id="winner-text"></div>
        <div id="final-stats" style="margin-bottom: 30px; font-size: 1.2rem;"></div>
        <button class="btn-main" onclick="location.reload()">Rematch</button>
    </div>
</div>

<script>
let bank = null; 
let peer, conn, role, idx=0, max=10, mode="gaming", truth=null, locked=false;
let scores = { host: 0, guest: 0 }, deck = [], currentDesigner="host";
let stealInterval;

async function initGame() {
    try {
        const response = await fetch('questions.json');
        bank = await response.json();
        document.getElementById("status").innerText = "Systems Active";
        const hBtn = document.getElementById("host-btn");
        hBtn.disabled = false;
        hBtn.innerText = "Host Versus";
    } catch (e) {
        document.getElementById("status").innerText = "Error: Use Localhost/Pages";
        console.error("Fetch failed", e);
    }
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function show(id) { 
    document.querySelectorAll(".container > div:not(#status):not(#live-points)").forEach(d => d.classList.add("hidden")); 
    document.getElementById(id).classList.remove("hidden"); 
}

function startHost() {
    if(!bank) return;
    mode = document.getElementById("mode-select").value;
    max = parseInt(document.getElementById("round-select").value);
    let pool = (mode === 'chaos') ? [].concat(...Object.values(bank)) : [...bank[mode]];
    deck = shuffle(pool).slice(0, max);
    peer = new Peer(Math.floor(1000 + Math.random() * 9000) + ""); role = "host";
    peer.on("open", id => { document.getElementById("room-id").innerText = id; show("screen-wait"); });
    peer.on("connection", c => { conn = c; setup(); });
}

function startJoin() {
    peer = new Peer(); role = "guest";
    peer.on("open", () => { 
        const id = document.getElementById("join-id").value;
        if(!id) return alert("Room code required");
        conn = peer.connect(id); setup(); 
    });
}

function setup() {
    conn.on("open", () => { 
        document.getElementById("status").innerText = "Sync Active";
        document.getElementById("live-points").classList.remove("hidden");
        if(role === "guest") conn.send({ type: "READY" }); 
    });
    conn.on("data", d => {
        if(d.type === "READY" && role === "host") { conn.send({ type: "START", mode, max, deck }); round(); }
        if(d.type === "START") { mode = d.mode; max = d.max; deck = d.deck; round(); }
        if(d.type === "TRUTH") { truth = d.order; ui(); render(deck[idx].opts, false); }
        if(d.type === "GUESS") { reveal(truth, d.order); }
        if(d.type === "NEXT") { idx = d.i; (idx >= max) ? showFinalScore() : round(); }
        if(d.type === "SYNC_SCORE") { scores = d.scores; updatePoints(); }
        if(d.type === "STEAL") { 
            clearInterval(stealInterval);
            currentDesigner = (role === "host") ? "guest" : "host"; 
            replay(); 
        }
        if(d.type === "SKIP") { handleSkip(); }
    });
}

function updatePoints() {
    document.getElementById("p-host-score").innerText = `Host: ${scores.host}`;
    document.getElementById("p-guest-score").innerText = `Guest: ${scores.guest}`;
}

function round() {
    truth = null; locked = false;
    currentDesigner = (idx % 2 === 0) ? "host" : "guest";
    replay();
}

function replay() {
    locked = false; 
    const btn = document.getElementById("submit");
    btn.disabled = false;
    btn.innerText = "Confirm Order";
    btn.classList.remove("hidden");

    document.getElementById("question").innerText = deck[idx].q;
    document.getElementById("round-info").innerText = `Round ${idx + 1} / ${max}`;
    const isGuesserWaiting = (role !== currentDesigner && !truth);
    render(deck[idx].opts, isGuesserWaiting);
    ui(); show("screen-game");
}

function ui() {
    const isCr = (role === currentDesigner);
    const tag = document.getElementById("role-tag");
    tag.innerText = isCr ? "‚≠ê DEFINE YOUR TRUTH" : (truth ? "üîç READ THEIR HEART" : "‚åõ OBSERVE OPTIONS...");
    tag.style.color = isCr ? "var(--p1)" : "var(--success)";
    document.getElementById("submit").classList.toggle("hidden", !isCr && !truth);
    document.getElementById("skip-btn").classList.toggle("hidden", !isCr && !truth);
}

function render(opts, isPreview) {
    const rl = document.getElementById("rank-list"); rl.innerHTML = "";
    opts.forEach(t => {
        const d = document.createElement("div");
        d.className = "rank-item" + (isPreview ? " rank-preview" : "");
        d.innerText = t;
        rl.appendChild(d);
    });
}

function requestSkip() {
    if(confirm("Skip this round?")) {
        conn.send({ type: "SKIP" });
        handleSkip();
    }
}

function handleSkip() {
    if(role === "host") {
        idx++;
        conn.send({type: "NEXT", i: idx});
        (idx >= max) ? showFinalScore() : round();
    } else {
        document.getElementById("status").innerText = "Skipping Round...";
    }
}

function sendOrder() {
    const btn = document.getElementById("submit");
    btn.innerText = "LOCKED ‚ù§";
    btn.disabled = true;
    const order = [...document.querySelectorAll(".rank-item")].map(x => x.innerText);
    locked = true; 
    if(!truth) { 
        truth = order; 
        conn.send({ type: "TRUTH", order }); 
    }
    else { 
        conn.send({ type: "GUESS", order }); 
        reveal(truth, order); 
    }
}

function reveal(t, g) {
    clearInterval(stealInterval);
    const list = document.getElementById("result-list"); list.innerHTML = ""; 
    let pts = 0;
    t.forEach((x, i) => {
        const actualPos = g.indexOf(x); const diff = Math.abs(i - actualPos);
        if(diff === 0) pts += 2; else if(diff === 1) pts += 1;
        let div = document.createElement("div"); div.className = "result-row";
        div.innerHTML = `<span>${x}</span><span style="color:${diff===0?'var(--success)':'rgba(255,255,255,0.3)'}">${diff===0?'Perfect Match':'Rank #'+(actualPos+1)}</span>`;
        list.appendChild(div);
    });
    
    if(role === "host") { 
        scores[(currentDesigner==='host'?'guest':'host')] += pts; 
        conn.send({ type: "SYNC_SCORE", scores }); 
        updatePoints(); 
    }
    
    const ctrl = document.getElementById("controls"); ctrl.innerHTML = "";
    const timerDisplay = document.getElementById("steal-timer");
    timerDisplay.innerText = "";

    if(role !== currentDesigner) {
        let timeLeft = 5;
        let b = document.createElement("button"); 
        b.className="btn-alt"; b.id="btn-steal-action";
        b.innerText=`Steal Turn (${timeLeft}s)`;
        b.onclick = () => { conn.send({type:"STEAL"}); currentDesigner=role; replay(); };
        ctrl.appendChild(b);

        stealInterval = setInterval(() => {
            timeLeft--;
            if(timeLeft > 0) b.innerText = `Steal Turn (${timeLeft}s)`;
            else { b.disabled = true; b.innerText = "Too Late"; clearInterval(stealInterval); }
        }, 1000);
    }

    if(role === "host") {
        let bNext = document.createElement("button"); 
        bNext.className="btn-main"; 
        bNext.innerText=(idx+1 >= max) ? "Conclusion" : "Proceed";
        bNext.onclick = () => { 
            clearInterval(stealInterval);
            idx++; 
            conn.send({type:"NEXT", i:idx}); 
            (idx >= max) ? showFinalScore() : round(); 
        };
        ctrl.appendChild(bNext);
    }
    show("screen-results");
}

function showFinalScore() {
    const winnerText = document.getElementById("winner-text");
    const stats = document.getElementById("final-stats");
    let winner = (scores.host > scores.guest) ? "HOST DOMINATES" : (scores.guest > scores.host) ? "GUEST VICTORIOUS" : "PERFECT HARMONY";
    winnerText.innerText = winner;
    stats.innerHTML = `<p style="color:var(--p1)">Host: ${scores.host}</p><p style="color:var(--success)">Guest: ${scores.guest}</p>`;
    document.getElementById("live-points").classList.add("hidden");
    show("screen-final");
}

// DRAG AND DROP (Mobile Optimized)
let active = null;
document.addEventListener("pointerdown", e => { 
    const item = e.target.closest(".rank-item");
    if(item && !item.classList.contains("rank-preview") && !locked) { 
        active = item; 
        active.classList.add("active"); 
        active.setPointerCapture(e.pointerId);
    } 
});

document.addEventListener("pointermove", e => {
    if(!active) return;
    let target = document.elementFromPoint(e.clientX, e.clientY);
    if(target) {
        let itemUnder = target.closest(".rank-item");
        if(itemUnder && itemUnder !== active && !itemUnder.classList.contains("rank-preview")) {
            let rect = itemUnder.getBoundingClientRect();
            let next = (e.clientY > rect.top + rect.height / 2);
            if(next) itemUnder.after(active);
            else itemUnder.before(active);
        }
    }
});

document.addEventListener("pointerup", e => { 
    if(active) {
        active.releasePointerCapture(e.pointerId);
        active.classList.remove("active"); 
        active = null; 
    }
});

initGame();
</script>
</body>
</html>
