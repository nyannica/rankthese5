<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>DuoRanker Multiplayer</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
:root{
--p1:#6366f1;
--p2:#ec4899;
--bg:#0f172a;
--card:#1e293b;
--text:#f8fafc;
--near:#eab308;
}

body{
margin:0;
font-family:system-ui;
background:var(--bg);
color:var(--text);
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
padding:1rem;
}

.container{
max-width:480px;
width:100%;
background:var(--card);
padding:1.5rem;
border-radius:24px;
text-align:center;
}

.hidden{display:none;}

button{
width:100%;
padding:1rem;
border:none;
border-radius:12px;
font-weight:bold;
cursor:pointer;
margin-top:8px;
}

.btn-main{background:var(--p1);color:white;}
.btn-wait{background:#111827;color:#555;border:1px solid #333;cursor:not-allowed;}

input,select{
width:100%;
padding:10px;
margin-bottom:10px;
border-radius:10px;
background:#111827;
color:white;
border:1px solid #333;
}

.rank-item{
background:#334155;
padding:12px;
margin-bottom:8px;
border-radius:12px;
cursor:grab;
touch-action:none;
transition:transform .15s ease, box-shadow .15s ease;
}

.rank-item.active{
transform:scale(1.05);
box-shadow:0 8px 20px rgba(0,0,0,.4);
cursor:grabbing;
}

.fade-in{
animation:fade .25s ease;
}

@keyframes fade{
from{opacity:0;transform:translateY(5px);}
to{opacity:1;transform:translateY(0);}
}
</style>
</head>

<body>

<div class="container">

<div id="status" style="font-size:.8rem;color:var(--near)">Disconnected</div>

<!-- START -->
<div id="screen-start">
<h1>DuoRanker</h1>

<select id="mode-select">
<option value="romance">Romance</option>
<option value="personal">Personal</option>
</select>

<select id="length-select">
<option value="10">10 Questions</option>
<option value="20">20 Questions</option>
<option value="30">30 Questions</option>
</select>

<button class="btn-main" onclick="startHost()">Host</button>

<div style="margin:10px">— OR —</div>

<input id="join-id" placeholder="Room Code">
<button onclick="startJoin()">Join</button>
</div>

<!-- WAIT -->
<div id="screen-wait" class="hidden">
<h2>Room Code</h2>
<h1 id="room-id">----</h1>
</div>

<!-- GAME -->
<div id="screen-game" class="hidden">
<h3 id="role"></h3>
<div id="timer">20s</div>
<h2 id="question"></h2>
<div id="rank-list"></div>
<button id="submit" class="btn-main" onclick="sendOrder()">Lock Order</button>
<p id="round"></p>
</div>

<!-- RESULTS -->
<div id="screen-results" class="hidden">
<h1 id="score">0%</h1>
<div id="controls"></div>
</div>

<!-- FINAL -->
<div id="screen-final" class="hidden">
<h1>Game Over</h1>
<h1 id="final">0%</h1>
<button onclick="location.reload()">Home</button>
</div>

</div>

<audio id="click" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
/* ---------- DATA ---------- */

const bank={
romance:[
{q:"Ideal First Date?",opts:["Dinner","Coffee","Arcade","Picnic","Movie"]},
{q:"Best Gesture?",opts:["Letter","Trip","Cooking","Gift","Hug"]}
],
personal:[
{q:"Life Phase?",opts:["Childhood","Teen","Adult","Career","Retirement"]},
{q:"Biggest Fear?",opts:["Failure","Alone","Pain","Crowd","Loss"]}
]
};

/* ---------- STATE ---------- */

let peer,conn,role;
let idx=0,mode="romance",max=10;
let truth=null,locked=false,total=0;
let timer=null,time=20,paused=false;

/* ---------- UI ---------- */

function show(id){
document.querySelectorAll(".container>div")
.forEach(d=>d.classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
}

function status(t){
document.getElementById("status").innerText=t;
}

/* ---------- HOST ---------- */

function startHost(){
mode=document.getElementById("mode-select").value;
max=parseInt(document.getElementById("length-select").value);

peer=new Peer(Math.floor(1000+Math.random()*9000)+"");
role="host";

peer.on("open",id=>{
document.getElementById("room-id").innerText=id;
show("screen-wait");
});

peer.on("connection",c=>{
conn=c;
setup();
});
}

/* ---------- GUEST ---------- */

function startJoin(){
peer=new Peer();
role="guest";

peer.on("open",()=>{
conn=peer.connect(document.getElementById("join-id").value);
setup();
});
}

/* ---------- CONNECTION ---------- */

function setup(){

conn.on("open",()=>{
status("Connected");

if(role==="host"){
conn.send({type:"INIT",mode,max});
sync();
show("screen-game");
round();
}
});

conn.on("data",d=>{

if(d.type==="INIT"){
mode=d.mode;
max=d.max;
show("screen-game"); // ⭐ guest enters game
}

if(d.type==="SYNC"){
idx=d.s.idx;
truth=d.s.truth;
paused=d.s.paused;
time=d.s.time;
show("screen-game"); // ⭐ guest sync fix
round();
startTimer();
}

if(d.type==="TRUTH"){truth=d.order;ui();}
if(d.type==="GUESS"){reveal(truth,d.order);}

if(d.type==="NEXT"){
idx=d.i;
if(idx>=max)final();
else round();
}

if(d.type==="PAUSE"){
paused=d.p;
if(!paused)startTimer();
}

});

conn.on("close",()=>status("Disconnected"));
}

/* ---------- SYNC ---------- */

function sync(){
if(role!=="host")return;
conn.send({
type:"SYNC",
s:{idx,truth,paused,time}
});
}

/* ---------- ROUND ---------- */

function round(){
truth=null;
locked=false;
time=20;

const q=bank[mode][idx%bank[mode].length];

document.getElementById("question").innerText=q.q;
document.getElementById("round").innerText=
`Round ${idx+1}/${max}`;

render(q.opts);
ui();
startTimer();
}

function ui(){

const chooser=
(idx%2===0&&role==="host")||
(idx%2!==0&&role==="guest");

const r=document.getElementById("role");
const b=document.getElementById("submit");

if(chooser){
r.innerText="Chooser";
b.classList.remove("hidden");
}
else if(!truth){
r.innerText="Waiting...";
b.classList.add("hidden");
}
else{
r.innerText="Guess";
b.classList.remove("hidden");
}

b.disabled=locked;
}

/* ---------- ORDER ---------- */

function sendOrder(){

document.getElementById("click").play();

const order=[...document.querySelectorAll(".rank-item")]
.map(x=>x.innerText);

locked=true;
ui();

if(!truth){
truth=order;
conn.send({type:"TRUTH",order});
}
else{
conn.send({type:"GUESS",order});
reveal(truth,order);
}
}

/* ---------- RESULTS ---------- */

function reveal(t,g){

show("screen-results");

let pts=0;

t.forEach((x,i)=>{
const d=Math.abs(i-g.indexOf(x));
if(d===0)pts+=2;
else if(d===1)pts+=1;
});

const s=Math.round((pts/10)*100);
total+=s;
document.getElementById("score").innerText=s+"%";

const c=document.getElementById("controls");

if(role==="host"){
c.innerHTML=`
<button onclick="pause()">${paused?"Resume":"Pause"}</button>
<button onclick="next()">
${idx+1>=max?"Finish":"Next"}
</button>`;
}
else{
c.innerHTML=`<button class="btn-wait">Waiting...</button>`;
}
}

/* ---------- NEXT ---------- */

function next(){
if(role!=="host")return;

idx++;
conn.send({type:"NEXT",i:idx});

if(idx>=max)final();
else round();
}

/* ---------- PAUSE ---------- */

function pause(){
if(role!=="host")return;
paused=!paused;
conn.send({type:"PAUSE",p:paused});
if(!paused)startTimer();
}

/* ---------- FINAL ---------- */

function final(){
show("screen-final");
document.getElementById("final").innerText=
Math.round(total/max)+"%";
}

/* ---------- TIMER ---------- */

function startTimer(){
clearInterval(timer);

timer=setInterval(()=>{
if(paused)return;

time--;
document.getElementById("timer").innerText=time+"s";

if(time<=0){
clearInterval(timer);
if(!locked)sendOrder();
}
},1000);
}

/* ---------- SWIPE SORT ---------- */

let active=null,startY=0;
const list=document.getElementById("rank-list");

list.addEventListener("pointerdown",e=>{
if(locked)return;
const item=e.target.closest(".rank-item");
if(!item)return;

active=item;
startY=e.clientY;
item.classList.add("active");
item.setPointerCapture(e.pointerId);
});

list.addEventListener("pointermove",e=>{
if(!active||locked)return;

const dy=e.clientY-startY;
active.style.transform=`translateY(${dy}px) scale(1.05)`;

const others=[...list.children].filter(x=>x!==active);

for(let o of others){
const box=o.getBoundingClientRect();
if(e.clientY<box.top+box.height/2){
list.insertBefore(active,o);
break;
}
}
});

list.addEventListener("pointerup",e=>{
if(!active)return;
active.classList.remove("active");
active.style.transform="";
active.releasePointerCapture(e.pointerId);
active=null;
});

/* ---------- RENDER ---------- */

function render(opts){
list.innerHTML="";
opts.sort(()=>Math.random()-.5).forEach(t=>{
const d=document.createElement("div");
d.className="rank-item fade-in";
d.innerText=t;
list.appendChild(d);
});
}
</script>

</body>
</html>
