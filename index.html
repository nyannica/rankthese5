<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoRanker - Custom Length</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p1: #6366f1; --p2: #ec4899; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #22c55e; --near: #eab308; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 1rem; min-height: 100vh; margin: 0; }
        .container { max-width: 480px; width: 100%; background: var(--card); padding: 1.5rem; border-radius: 28px; text-align: center; align-self: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        .role-banner { background: rgba(99, 102, 241, 0.2); padding: 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; color: var(--p1); border: 1px solid var(--p1); }
        .role-chooser { color: var(--p2); border-color: var(--p2); background: rgba(236, 72, 153, 0.1); }

        #rank-list { list-style: none; padding: 0; margin: 1.5rem 0; }
        .rank-item { background: #334155; margin-bottom: 10px; padding: 1rem; border-radius: 14px; cursor: grab; display: flex; align-items: center; text-align: left; font-size: 0.95rem; }
        .rank-item.dragging { opacity: 0.4; border: 2px solid var(--p1); }

        .comparison-stack { margin-top: 20px; display: flex; flex-direction: column; gap: 8px; }
        .res-item { display: flex; align-items: center; background: #0f172a; padding: 12px; border-radius: 16px; border-left: 5px solid #475569; }
        .res-item.perfect { border-left-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .res-item.close { border-left-color: var(--near); background: rgba(234, 179, 8, 0.1); }
        .res-rank { font-weight: 800; width: 30px; color: #94a3b8; }
        .res-content { flex-grow: 1; text-align: left; padding-left: 10px; }

        button { width: 100%; padding: 1.1rem; border-radius: 14px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .btn-main { background: var(--p1); color: white; margin-top: 10px; }
        .btn-locked { background: var(--success) !important; cursor: default; }
        
        select, input { width: 100%; padding: 12px; border-radius: 12px; background: #0f172a; color: white; border: 1px solid #475569; margin-bottom: 15px; box-sizing: border-box; }
        .hidden { display: none; }
        .progress-text { font-size: 0.75rem; color: #64748b; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-start">
        <h1>DuoRanker</h1>
        <label style="font-size: 0.8rem; color: #94a3b8; display: block; text-align: left; margin-bottom: 5px;">Category:</label>
        <select id="mode-select">
            <option value="romance">30 Romance Q&A</option>
            <option value="personal">30 Personal Q&A</option>
        </select>
        
        <label style="font-size: 0.8rem; color: #94a3b8; display: block; text-align: left; margin-bottom: 5px;">Number of Rounds:</label>
        <select id="length-select">
            <option value="10">10 Questions</option>
            <option value="20">20 Questions</option>
            <option value="30">30 Questions</option>
        </select>

        <button class="btn-main" onclick="startHost()">Host Game</button>
        <div style="margin:15px; color:#475569;">— OR —</div>
        <input type="text" id="join-id" placeholder="Partner's Code">
        <button style="background:#334155; color:white;" onclick="startJoin()">Join Game</button>
    </div>

    <div id="screen-waiting" class="hidden">
        <h3>Invite Code</h3>
        <h1 id="my-id-display" style="font-size: 3.5rem; color: var(--p1); margin: 0;">----</h1>
        <p>Waiting for connection...</p>
    </div>

    <div id="screen-game" class="hidden">
        <div id="role-indicator" class="role-banner">Your Role...</div>
        <h2 id="question-text" style="margin: 0;">...</h2>
        <div id="rank-list"></div>
        <button id="submit-btn" class="btn-main" onclick="sendOrder()">Lock My Ranking</button>
        <div id="round-counter" class="progress-text">Question 1 of --</div>
    </div>

    <div id="screen-results" class="hidden">
        <div id="score-display" style="font-size: 4rem; font-weight: 900; color: var(--p2);">0%</div>
        <div class="comparison-stack" id="full-reveal"></div>
        <button id="next-btn" class="btn-main" onclick="nextRound()" style="margin-top: 20px;">Next Round →</button>
    </div>

    <div id="screen-final" class="hidden">
        <h1>Game Over!</h1>
        <p>Your Average Connection Score:</p>
        <div id="final-score" style="font-size: 5rem; font-weight: 900; color: var(--success);">0%</div>
        <button class="btn-main" onclick="location.reload()">Play Again</button>
    </div>
</div>

<script>
    // Note: Re-insert the 60 questions from previous response into this object
    const questionBank = {
        romance: [
            { q: "Ideal First Date?", opts: ["Fancy Rooftop Dinner", "Cozy Coffee Shop", "Amusement Park", "Starlit Picnic", "Arcade/Bowling"] },
            // ... (Add all 30 romance questions)
        ],
        personal: [
            { q: "Best Life Phase?", opts: ["Childhood", "High School", "Young Adult", "Established Career", "Retirement"] },
            // ... (Add all 30 personal questions)
        ]
    };

    let peer, conn, myRole, truth, currentIdx = 0, mode = 'romance', maxRounds = 10, locked = false;
    let totalScore = 0;

    function startHost() {
        mode = document.getElementById('mode-select').value;
        maxRounds = parseInt(document.getElementById('length-select').value);
        const id = Math.floor(1000 + Math.random() * 9000).toString();
        peer = new Peer(id); myRole = 'host';
        peer.on('open', (i) => { document.getElementById('my-id-display').innerText = i; show('screen-waiting'); });
        peer.on('connection', (c) => { conn = c; handleConn(); });
    }

    function startJoin() {
        const tid = document.getElementById('join-id').value;
        peer = new Peer(); myRole = 'guest';
        peer.on('open', () => { conn = peer.connect(tid); handleConn(); });
    }

    function handleConn() {
        conn.on('open', () => { 
            if(myRole==='host') conn.send({type:'INIT', mode, maxRounds});
            show('screen-game'); startRound(); 
        });
        conn.on('data', (d) => {
            if(d.type==='INIT') { mode = d.mode; maxRounds = d.maxRounds; startRound(); }
            if(d.type==='TRUTH') { truth = d.order; updateUI(); }
            if(d.type==='GUESS') { revealAll(truth, d.order); }
            if(d.type==='NEXT') { currentIdx++; startRound(); }
        });
    }

    function startRound() {
        if (currentIdx >= maxRounds) { showFinalScore(); return; }
        show('screen-game'); truth = null; locked = false;
        const q = questionBank[mode][currentIdx % 30];
        document.getElementById('question-text').innerText = q.q;
        document.getElementById('round-counter').innerText = `Question ${currentIdx + 1} of ${maxRounds}`;
        renderList(q.opts);
        updateUI();
    }

    function updateUI() {
        const isChooser = (currentIdx % 2 === 0 && myRole === 'host') || (currentIdx % 2 !== 0 && myRole === 'guest');
        const roleEl = document.getElementById('role-indicator');
        const btn = document.getElementById('submit-btn');

        if(isChooser) {
            roleEl.innerText = "YOUR ROLE: CHOOSER (Set the Truth)";
            roleEl.className = "role-banner role-chooser";
            btn.classList.remove('hidden');
        } else if (!truth) {
            roleEl.innerText = "YOUR ROLE: GUESSER (Wait for Partner)";
            roleEl.className = "role-banner";
            btn.classList.add('hidden');
        } else {
            roleEl.innerText = "YOUR ROLE: GUESSER (Make your Guess!)";
            roleEl.className = "role-banner";
            btn.classList.remove('hidden');
        }

        if (locked) { btn.innerText = "✓ LOCKED IN"; btn.className = "btn-main btn-locked"; }
        else { btn.innerText = "LOCK MY RANKING"; btn.className = "btn-main"; }
    }

    function sendOrder() {
        const order = [...document.querySelectorAll('.rank-item')].map(li => li.innerText);
        locked = true; updateUI();
        if(!truth) { conn.send({type:'TRUTH', order}); truth = order; }
        else { conn.send({type:'GUESS', order}); revealAll(truth, order); }
    }

    function revealAll(truthArr, guessArr) {
        show('screen-results');
        const stack = document.getElementById('full-reveal');
        stack.innerHTML = "";
        let pts = 0;

        truthArr.forEach((item, i) => {
            const gIdx = guessArr.indexOf(item);
            const dist = Math.abs(i - gIdx);
            if(dist === 0) pts += 2; else if(dist === 1) pts += 1;

            const div = document.createElement('div');
            div.className = `res-item ${dist === 0 ? 'perfect' : (dist === 1 ? 'close' : '')}`;
            div.innerHTML = `
                <div class="res-rank">#${i + 1}</div>
                <div class="res-content"><span style="font-weight:bold">${item}</span><br><span style="font-size:0.75rem; color:#64748b">Guessed: #${gIdx+1}</span></div>
            `;
            stack.appendChild(div);
        });
        const roundScore = Math.round((pts/10)*100);
        totalScore += roundScore;
        document.getElementById('score-display').innerText = roundScore + "%";
        
        if (currentIdx + 1 >= maxRounds) {
            document.getElementById('next-btn').innerText = "See Final Results";
        }
    }

    function showFinalScore() {
        show('screen-final');
        const avg = Math.round(totalScore / maxRounds);
        document.getElementById('final-score').innerText = avg + "%";
    }

    function renderList(opts) {
        const list = document.getElementById('rank-list');
        list.innerHTML = "";
        opts.sort(()=>Math.random()-0.5).forEach(t => {
            const li = document.createElement('div');
            li.className = 'rank-item'; li.draggable = true; li.innerText = t;
            li.addEventListener('dragstart', () => { if(!locked) li.classList.add('dragging') });
            li.addEventListener('dragend', () => li.classList.remove('dragging'));
            list.appendChild(li);
        });
    }

    document.getElementById('rank-list').addEventListener('dragover', e => {
        if(locked) return;
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        const list = document.getElementById('rank-list');
        const after = [...list.querySelectorAll('.rank-item:not(.dragging)')].find(el => e.clientY <= el.getBoundingClientRect().top + el.getBoundingClientRect().height/2);
        list.insertBefore(dragging, after || null);
    });

    function nextRound() { 
        if (currentIdx + 1 >= maxRounds) { showFinalScore(); return; }
        currentIdx++; 
        conn.send({type:'NEXT'}); 
        startRound(); 
    }
    function show(id) { document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
</script>
</body>
</html>
