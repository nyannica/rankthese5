<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuoRanker: Soulmates</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            --p1: #be123c; --p2: #701a75; --bg: #0a0505; --card: #1a0b0b; 
            --text: #ffe4e6; --success: #f43f5e; --near: #fb7185; --skip: #4c0519; --accent: #fda4af; 
        }
        body { 
            margin:0; font-family: 'Georgia', serif; background: var(--bg); 
            background-image: radial-gradient(circle at center, #2d0606 0%, #0a0505 100%);
            color:var(--text); display:flex; justify-content:center; align-items:center; 
            min-height:100vh; padding:1rem; overflow:hidden; touch-action: none; 
        }
        .container { 
            max-width:480px; width:100%; background:var(--card); padding:2rem; 
            border-radius:32px; text-align:center; box-shadow: 0 0 30px rgba(190, 18, 60, 0.2);
            border: 1px solid rgba(190, 18, 60, 0.3); max-height:95vh; overflow-y:auto; 
        }
        h1 { font-style: italic; color: var(--accent); }
        .hidden { display:none !important; }
        
        button { 
            width:100%; padding:1.1rem; border:none; border-radius:100px; 
            font-weight:bold; cursor:pointer; margin-top:12px; transition:0.3s; 
            font-size:1rem; color:white; text-transform: uppercase;
        }
        .btn-main { background: linear-gradient(45deg, var(--p1), #881337); }
        .btn-alt { background: linear-gradient(45deg, var(--p2), #4a044e); }
        .btn-outline { background: transparent; border: 1px solid var(--p1); color: var(--accent); }
        
        /* Unified styling for Category, Rounds, and Partner Code */
        input, select { 
            width:100%; padding:14px; margin-bottom:12px; border-radius:15px; 
            background:#000000; color:var(--accent); border:1px solid #4c0519; 
            box-sizing:border-box; font-size:1rem; text-align: center;
            font-family: 'Georgia', serif;
        }

        /* Matches the text color and placeholder of the dropdowns */
        #join-id {
            margin-top: 15px;
            text-transform: uppercase;
            color: var(--accent) !important; 
        }
        #join-id::placeholder {
            color: var(--accent);
            opacity: 0.7;
        }

        .rank-item { 
            background: rgba(76, 5, 25, 0.3); padding:16px; border-radius:15px; 
            cursor:grab; text-align:left; margin-bottom:10px; border:1px solid rgba(190, 18, 60, 0.2);
        }
        .rank-item.active { background:var(--p1); transform: scale(1.05); }
        #live-points { display: flex; justify-content: space-around; margin-bottom: 20px; font-size: 0.8rem; }
        .result-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; }
        
        #cat-badge {
            display: inline-block; padding: 4px 12px; background: var(--p2);
            border-radius: 20px; font-size: 0.6rem; font-weight: bold;
            letter-spacing: 1px; margin-bottom: 10px; text-transform: uppercase;
            border: 1px solid var(--accent);
        }
    </style>
</head>
<body>

<div class="container">
    <div id="status" style="font-size:0.6rem; color:var(--p1); margin-bottom:5px;">Initializing...</div>
    
    <div id="live-points" class="hidden">
        <span id="p-host-score">Host: 0</span>
        <span id="p-guest-score">Guest: 0</span>
    </div>

    <div id="screen-start">
        <h1>DuoRanker</h1>
        <select id="mode-select" onchange="toggleCustomBtn()">
            <option value="romance">Romance üíñ</option>
            <option value="personal">Compatibility üèπ</option>
            <option value="gaming">Video Games üéÆ</option>
            <option value="travel">Travel ‚úàÔ∏è</option>
            <option value="chaos">üî• CHAOS MODE</option>
            <option value="custom">‚úçÔ∏è CUSTOM QUESTIONS</option>
        </select>
        <select id="round-select">
            <option value="5">5 Rounds</option>
            <option value="10" selected>10 Rounds</option>
        </select>
        <button id="host-btn" class="btn-main" onclick="startHost()" disabled>Loading...</button>
        <input id="join-id" placeholder="PARTNER CODE" type="tel">
        <button class="btn-outline" onclick="startJoin()">Join Game</button>
    </div>

    <div id="screen-custom" class="hidden">
        <h2 id="custom-title">Create Question</h2>
        <input id="custom-q" placeholder="Enter Question Here">
        <div id="custom-opts">
            <input class="custom-opt" placeholder="Option 1">
            <input class="custom-opt" placeholder="Option 2">
            <input class="custom-opt" placeholder="Option 3">
            <input class="custom-opt" placeholder="Option 4">
            <input class="custom-opt" placeholder="Option 5">
        </div>
        <button class="btn-main" onclick="saveCustomAndHost()">Begin Game</button>
        <button class="btn-outline" onclick="show('screen-start')">Back</button>
    </div>

    <div id="screen-wait" class="hidden">
        <p>Waiting for Partner...</p>
        <h1 id="room-id" style="font-size:3rem; color:var(--p1);">----</h1>
    </div>

    <div id="screen-game" class="hidden">
        <div id="cat-badge" class="hidden"></div>
        <div id="role-tag" style="font-size:0.7rem; font-weight:bold; margin-bottom:5px;"></div>
        <h2 id="question"></h2>
        <div id="rank-list"></div>
        <button id="submit" class="btn-main" onclick="sendOrder()">Lock My Order</button>
    </div>

    <div id="screen-results" class="hidden">
        <h2>Results</h2>
        <div id="result-list"></div>
        <div id="controls"></div>
    </div>

    <div id="screen-final" class="hidden">
        <h1 id="winner-text"></h1>
        <div id="final-stats"></div>
        <div id="post-game-controls"></div>
        <button class="btn-outline" style="margin-top:20px" onclick="location.reload()">Exit</button>
    </div>
</div>

<script>
let bank=null, peer, conn, role, idx=0, max=10, mode="romance", truth=null, locked=false;
let scores={host:0, guest:0}, deck=[], currentDesigner="host";
let swapTurnPending = false; 

async function initGame() {
    try {
        const res = await fetch('questions.json');
        bank = await res.json();
        document.getElementById("host-btn").disabled = false;
        document.getElementById("host-btn").innerText = "Host Game";
        document.getElementById("status").innerText = "Ready";
    } catch(e) { document.getElementById("status").innerText = "Data Load Error"; }
}

function show(id) { 
    document.querySelectorAll(".container > div:not(#status):not(#live-points)").forEach(d => d.classList.add("hidden")); 
    document.getElementById(id).classList.remove("hidden");
}

function toggleCustomBtn() {
    const isCustom = document.getElementById("mode-select").value === "custom";
    document.getElementById("host-btn").innerText = isCustom ? "Create Question" : "Host Game";
}

function startHost() {
    mode = document.getElementById("mode-select").value;
    if(mode === "custom") {
        swapTurnPending = false;
        document.getElementById("custom-title").innerText = "Host Sets Question";
        return show("screen-custom");
    }
    max = parseInt(document.getElementById("round-select").value);
    initPoolAndPeer();
}

function initPoolAndPeer() {
    let pool = [];
    if(mode === 'chaos') {
        Object.keys(bank).forEach(cat => bank[cat].forEach(qObj => pool.push({...qObj, category: cat})));
    } else { pool = [...bank[mode]]; }
    deck = pool.sort(() => Math.random() - 0.5).slice(0, max);
    initPeer();
}

function saveCustomAndHost() {
    const q = document.getElementById("custom-q").value;
    const opts = [...document.querySelectorAll(".custom-opt")].map(i=>i.value).filter(v=>v.trim());
    if(!q || opts.length < 2) return alert("Needs a question + at least 2 options!");
    
    deck = [{q, opts, category: "custom"}];
    
    if (swapTurnPending) {
        idx = 1; max = 2; // Index 1 ensures Guest starts (Designer logic: odd=Guest)
        deck = [deck[0], deck[0]]; 
        conn.send({type:"START", mode, max, deck, i:idx});
        round();
    } else {
        idx = 0; max = 1;
        if(conn && conn.open) {
            conn.send({type:"START", mode, max, deck, i:0});
            round();
        } else { initPeer(); }
    }
    // Clear inputs
    document.getElementById("custom-q").value = "";
    document.querySelectorAll(".custom-opt").forEach(i => i.value = "");
}

function initPeer() {
    peer = new Peer(Math.floor(1000 + Math.random()*9000));
    role = "host";
    peer.on('open', id => { document.getElementById("room-id").innerText=id; show("screen-wait"); });
    peer.on('connection', c => { conn = c; setupConn(); });
}

function startJoin() {
    peer = new Peer(); role = "guest";
    peer.on('open', () => {
        const id = document.getElementById("join-id").value;
        if(!id) return alert("Enter a partner code!");
        conn = peer.connect(id); setupConn();
    });
}

function setupConn() {
    conn.on('open', () => {
        document.getElementById("live-points").classList.remove("hidden");
        if(role === "guest") conn.send({type:"READY"});
    });
    conn.on('data', d => {
        if(d.type === "READY") { conn.send({type:"START", mode, max, deck, i:0}); round(); }
        if(d.type === "START") { mode=d.mode; max=d.max; deck=d.deck; idx=d.i; round(); }
        if(d.type === "TRUTH") { truth=d.order; ui(); render(deck[idx].opts, false); }
        if(d.type === "GUESS") reveal(truth, d.order);
        if(d.type === "NEXT") { idx=d.i; (idx >= max) ? showFinal() : round(); }
        if(d.type === "SYNC") { scores=d.scores; updatePoints(); }
    });
}

function updatePoints() {
    document.getElementById("p-host-score").innerText = `Host: ${scores.host}`;
    document.getElementById("p-guest-score").innerText = `Guest: ${scores.guest}`;
}

function round() {
    truth = null; locked = false;
    currentDesigner = (idx % 2 === 0) ? "host" : "guest";
    const badge = document.getElementById("cat-badge");
    if (mode === "chaos" && deck[idx].category) {
        badge.innerText = `From: ${deck[idx].category}`;
        badge.classList.remove("hidden");
    } else { badge.classList.add("hidden"); }
    document.getElementById("question").innerText = deck[idx].q;
    render(deck[idx].opts, (role !== currentDesigner));
    ui(); show("screen-game");
}

function render(opts, isWait) {
    const rl = document.getElementById("rank-list"); rl.innerHTML = "";
    opts.forEach(t => {
        const d = document.createElement("div"); d.className = "rank-item";
        d.innerText = t; rl.appendChild(d);
    });
}

function ui() {
    const isCr = (role === currentDesigner);
    document.getElementById("role-tag").innerText = isCr ? "‚≠ê SET THE TRUTH" : (truth ? "üîç YOUR GUESS" : "‚åõ WAITING...");
    document.getElementById("submit").classList.toggle("hidden", !isCr && !truth);
}

function sendOrder() {
    const order = [...document.querySelectorAll(".rank-item")].map(x=>x.innerText);
    locked = true; document.getElementById("submit").classList.add("hidden");
    if(!truth) { truth=order; conn.send({type:"TRUTH", order}); }
    else { conn.send({type:"GUESS", order}); reveal(truth, order); }
}

function reveal(t, g) {
    const list = document.getElementById("result-list"); list.innerHTML = "";
    let pts = 0;
    t.forEach((x, i) => {
        const diff = Math.abs(i - g.indexOf(x));
        if(diff === 0) pts += 2; else if(diff === 1) pts += 1;
        list.innerHTML += `<div class="result-row"><span>${x}</span><span>Rank #${g.indexOf(x)+1}</span></div>`;
    });
    if(role === "host") { 
        scores[currentDesigner==='host'?'guest':'host'] += pts; 
        conn.send({type:"SYNC", scores}); updatePoints(); 
        const btn = document.createElement("button"); btn.className="btn-main";
        btn.innerText = (idx + 1 >= max) ? "Final Results" : "Next Round";
        btn.onclick = () => { idx++; conn.send({type:"NEXT", i:idx}); (idx>=max)?showFinal():round(); };
        document.getElementById("controls").innerHTML = ""; document.getElementById("controls").appendChild(btn);
    }
    show("screen-results");
}

function showFinal() {
    const win = (scores.host > scores.guest) ? "HOST WINS ü•Ä" : (scores.guest > scores.host ? "GUEST WINS ü•Ä" : "SOUL BOUND ü§ù");
    document.getElementById("winner-text").innerText = win;
    document.getElementById("final-stats").innerHTML = `<p>Host: ${scores.host} | Guest: ${scores.guest}</p>`;
    
    const ctrl = document.getElementById("post-game-controls"); ctrl.innerHTML = "";
    if(role === "host") {
        const btnNext = document.createElement("button"); btnNext.className="btn-main";
        btnNext.innerText = (mode === "custom") ? "Host Sets New" : "Play Again";
        btnNext.onclick = () => {
            if(mode === "custom") {
                swapTurnPending = false;
                document.getElementById("custom-title").innerText = "Host Sets Question";
                show("screen-custom");
            } else {
                idx = 0;
                initPoolAndPeer(); 
                conn.send({type:"START", mode, max, deck, i:0}); round();
            }
        };
        const btnSwap = document.createElement("button"); btnSwap.className="btn-alt";
        btnSwap.innerText = (mode === "custom") ? "Guest Sets New" : "Swap: Guest Starts";
        btnSwap.onclick = () => {
            if(mode === "custom") {
                swapTurnPending = true;
                document.getElementById("custom-title").innerText = "Create for Guest";
                show("screen-custom");
            } else {
                idx = 1; 
                conn.send({type:"START", mode, max, deck, i:idx}); round();
            }
        };
        ctrl.appendChild(btnNext); ctrl.appendChild(btnSwap);
    }
    show("screen-final");
}

// Simple Drag & Drop
let active = null;
document.addEventListener("pointerdown", e => { active = e.target.closest(".rank-item"); if(active && !locked) active.classList.add("active"); });
document.addEventListener("pointermove", e => {
    if(!active || locked) return;
    const target = document.elementFromPoint(e.clientX, e.clientY)?.closest(".rank-item");
    if(target && target !== active) target.after(active);
});
document.addEventListener("pointerup", () => { if(active) active.classList.remove("active"); active=null; });

initGame();
</script>
</body>
</html>
