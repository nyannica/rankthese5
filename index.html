<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoRanker - Host Sync</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p1: #6366f1; --p2: #ec4899; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #22c55e; --near: #eab308; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 1rem; min-height: 100vh; margin: 0; }
        .container { max-width: 480px; width: 100%; background: var(--card); padding: 1.5rem; border-radius: 28px; text-align: center; align-self: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        /* Banner & Labels */
        .role-banner { background: rgba(99, 102, 241, 0.2); padding: 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; border: 1px solid var(--p1); }
        .role-chooser { color: var(--p2); border-color: var(--p2); background: rgba(236, 72, 153, 0.1); }
        .role-guesser { color: var(--p1); border-color: var(--p1); background: rgba(99, 102, 241, 0.1); }

        /* Draggable List */
        #rank-list { list-style: none; padding: 0; margin: 1.5rem 0; }
        .rank-item { background: #334155; margin-bottom: 10px; padding: 1rem; border-radius: 14px; cursor: grab; display: flex; align-items: center; text-align: left; font-size: 0.95rem; border: 2px solid transparent; }
        .rank-item.dragging { opacity: 0.4; border-color: var(--p1); }

        /* Comparison Stack */
        .comparison-stack { margin-top: 20px; display: flex; flex-direction: column; gap: 8px; text-align: left; }
        .res-item { display: flex; align-items: center; background: #0f172a; padding: 12px; border-radius: 16px; border-left: 5px solid #475569; }
        .res-item.perfect { border-left-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .res-item.close { border-left-color: var(--near); background: rgba(234, 179, 8, 0.1); }
        .res-rank { font-weight: 800; width: 30px; color: #94a3b8; font-size: 1.1rem; }
        .res-content { flex-grow: 1; padding-left: 10px; }

        /* Buttons & Inputs */
        button { width: 100%; padding: 1.1rem; border-radius: 14px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: 0.2s; }
        .btn-main { background: var(--p1); color: white; }
        .btn-locked { background: var(--success) !important; cursor: default; }
        .btn-wait { background: #1e293b !important; color: #64748b; border: 1px solid #334155 !important; cursor: not-allowed; }
        
        select, input { width: 100%; padding: 12px; border-radius: 12px; background: #0f172a; color: white; border: 1px solid #475569; margin-bottom: 15px; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-start">
        <h1>DuoRanker</h1>
        <select id="mode-select">
            <option value="romance">30 Romance Q&A</option>
            <option value="personal">30 Personal Q&A</option>
        </select>
        <select id="length-select">
            <option value="10">10 Questions</option>
            <option value="20">20 Questions</option>
            <option value="30">30 Questions</option>
        </select>
        <button class="btn-main" onclick="startHost()">Host Game</button>
        <div style="margin:15px; color:#475569;">— OR —</div>
        <input type="text" id="join-id" placeholder="Enter Partner's Code">
        <button style="background:#334155; color:white;" onclick="startJoin()">Join Partner</button>
    </div>

    <div id="screen-waiting" class="hidden">
        <h3>Room Code</h3>
        <h1 id="my-id-display" style="font-size: 3.5rem; color: var(--p1); margin: 0;">----</h1>
        <p>Waiting for connection...</p>
    </div>

    <div id="screen-game" class="hidden">
        <div id="role-indicator" class="role-banner">Your Role</div>
        <h2 id="question-text">...</h2>
        <div id="rank-list"></div>
        <button id="submit-btn" class="btn-main" onclick="sendOrder()">Lock Order</button>
        <p id="round-counter" style="font-size: 0.8rem; color: #64748b; margin-top: 10px;"></p>
    </div>

    <div id="screen-results" class="hidden">
        <div id="score-display" style="font-size: 4rem; font-weight: 900; color: var(--p2);">0%</div>
        <div class="comparison-stack" id="full-reveal"></div>
        
        <div id="host-controls" style="margin-top: 20px;"></div>
    </div>

    <div id="screen-final" class="hidden">
        <h1>Final Connection</h1>
        <div id="final-score" style="font-size: 5rem; font-weight: 900; color: var(--success);">0%</div>
        <button class="btn-main" onclick="location.reload()">Back to Home</button>
    </div>
</div>

<script>
    // 30 Romance & 30 Personal Questions
    const questionBank = {
        romance: [
            { q: "Ideal First Date?", opts: ["Fancy Dinner", "Coffee Shop", "Amusement Park", "Starlit Picnic", "Arcade"] },
            { q: "Best Gesture?", opts: ["Love Letter", "Surprise Trip", "Cooking", "PDA", "Small Gifts"] },
            { q: "Physical Touch?", opts: ["Holding Hands", "Hugs", "Forehead Kisses", "Cuddling", "Massages"] },
            { q: "Honeymoon?", opts: ["Maldives", "Paris", "Swiss Alps", "Tokyo", "Mediterranean"] },
            { q: "Couple Activity?", opts: ["Movies", "Cooking", "Gym", "Traveling", "Gaming"] },
            { q: "Attractive Trait?", opts: ["Humor", "Ambition", "Compassion", "Intelligence", "Style"] },
            { q: "Morning Vibe?", opts: ["Cuddling", "Breakfast", "Morning Walk", "Quiet Coffee", "Gym"] },
            { q: "Love Language?", opts: ["Words", "Service", "Gifts", "Time", "Touch"] },
            { q: "Movie Genre?", opts: ["Rom-Com", "Drama", "Action", "Horror", "Sci-Fi"] },
            { q: "Anniversary?", opts: ["Night In", "Party", "Adventure", "Gift Exchange", "Dining"] },
            { q: "Chill Vibe?", opts: ["Wine & Music", "Netflix", "Deep Talk", "Read Together", "Stargazing"] },
            { q: "Core Value?", opts: ["Trust", "Passion", "Communication", "Consistency", "Shared Interests"] },
            { q: "Crush Type?", opts: ["Rebellious", "Academic", "Athlete", "Artist", "Funny"] },
            { q: "Future Home?", opts: ["Cottage", "Penthouse", "World Traveler", "Big Family", "Art Studio"] },
            { q: "Gift Type?", opts: ["Jewelry", "Tech", "Experiences", "Handmade", "Books/Flowers"] },
            { q: "Rainy Day?", opts: ["Napping", "Board Games", "Baking", "Records", "Series Binge"] },
            { q: "Living Together?", opts: ["Sleeping Together", "Shared Meals", "Inside Jokes", "Support", "Home Decor"] },
            { q: "Conflict?", opts: ["Talk Now", "Cool Down", "Message", "Hug it Out", "Logical Debate"] },
            { q: "Music?", opts: ["Acoustic", "Pop", "R&B", "Rock", "Indie"] },
            { q: "Proposal?", opts: ["Private", "Public", "Surprise Party", "On a Trip", "Meaningful Spot"] },
            { q: "Goal?", opts: ["Best Friends", "Power Couple", "Adventurers", "Calm/Stable", "Inspirers"] },
            { q: "Scent?", opts: ["Citrus", "Vanilla", "Woody", "Floral", "Ocean"] },
            { q: "Dinner?", opts: ["Sushi", "Steak", "Pasta", "Street Food", "Tacos"] },
            { q: "Dance?", opts: ["Slow Dance", "Silly", "Ballroom", "Clubs", "No Dance"] },
            { q: "Photos?", opts: ["Candids", "Portraits", "Landscape", "Selfies", "Memories Only"] },
            { q: "Travel?", opts: ["Resort", "Backpacking", "City Hopping", "Road Trip", "Cruising"] },
            { q: "Bedroom?", opts: ["Minimalist", "Boho", "Dark", "Colorful", "Cozy"] },
            { q: "Pet?", opts: ["Dog", "Cat", "Exotic", "Birds", "No Pets"] },
            { q: "Compliment?", opts: ["Appearance", "Personality", "Achievement", "Effort", "Vibe"] },
            { q: "Sweet?", opts: ["Dark Choc", "Ice Cream", "Pastry", "Gummies", "Cake"] }
        ],
        personal: [
            { q: "Life Phase?", opts: ["Childhood", "High School", "Young Adult", "Career", "Retirement"] },
            { q: "Fear?", opts: ["Alone", "Failure", "Public Speaking", "Pain", "Control"] },
            { q: "Strength?", opts: ["Resilience", "Empathy", "Logic", "Creativity", "Discipline"] },
            { q: "Habit?", opts: ["Early Rising", "Night Owl", "Journaling", "Meditation", "Exercise"] },
            { q: "Stress Relief?", opts: ["Music", "Sleep", "Talk", "Cleaning", "Exercise"] },
            { q: "Dream Job?", opts: ["Artist", "CEO", "Teacher", "Scientist", "Nomad"] },
            { q: "Battery?", opts: ["Introvert", "Extrovert", "Ambivert", "Selective", "Homebody"] },
            { q: "Routine?", opts: ["Gym", "Phone/Coffee", "Meditate", "Late Sleep", "To-Do List"] },
            { q: "Workplace?", opts: ["Office", "Home", "Nature", "Studio", "Cafe"] },
            { q: "Essential?", opts: ["Camera", "Playlist", "Shoes", "Kindle", "Map"] },
            { q: "Skill?", opts: ["Cooking", "Logic", "Listening", "Organizing", "Stories"] },
            { q: "Philosophy?", opts: ["Work Hard", "Peace", "Present Moment", "Growth", "Altruism"] },
            { q: "Weekend?", opts: ["Productive", "Recovery", "Social", "Hiking", "Hobbies"] },
            { q: "Drink?", opts: ["Iced Coffee", "Matcha", "Smoothie", "Water", "Beer/Wine"] },
            { q: "Style?", opts: ["Streetwear", "Minimalist", "Vintage", "Athleisure", "Casual"] },
            { q: "Memory?", opts: ["Visual", "Audio", "Emotional", "Context", "Smell"] },
            { q: "Peeve?", opts: ["Lateness", "Chewing", "Ignorance", "Mess", "Lying"] },
            { q: "Spending?", opts: ["Saver", "Impulse", "Quality", "Experiences", "Giver"] },
            { q: "Comfort?", opts: ["Pizza", "Soup", "Chocolate", "Burger", "Home Meal"] },
            { q: "Talent?", opts: ["Accents", "Trivia", "Math", "Intuition", "Fixing"] },
            { q: "Daily?", opts: ["Smile", "Tasks", "Learn", "Health", "Peace"] },
            { q: "Home?", opts: ["Skyscraper", "Suburbs", "Farm", "Island", "Van"] },
            { q: "Season?", opts: ["Fall", "Spring", "Summer", "Winter", "Rain"] },
            { q: "Brain?", opts: ["Analytical", "Creative", "Verbal", "Spacial", "Emotional"] },
            { q: "Phone?", opts: ["Scroll", "Texting", "Voice Notes", "Photos", "Unplugged"] },
            { q: "Childhood?", opts: ["Astronaut", "Athlete", "Singer", "Vet", "Teacher"] },
            { q: "Reading?", opts: ["Fiction", "Self-Help", "Articles", "Biography", "Graphic"] },
            { q: "Resolution?", opts: ["Face to Face", "Space", "Debate", "Compromise", "Avoidance"] },
            { q: "Party?", opts: ["Center", "Corner Talk", "DJ", "Snack Table", "Leaves Early"] },
            { q: "Need?", opts: ["Time", "Energy", "Money", "Peace", "Adventure"] }
        ]
    };

    let peer, conn, myRole, currentIdx = 0, mode = 'romance', maxRounds = 10;
    let truth = null, locked = false, totalScore = 0;

    function startHost() {
        mode = document.getElementById('mode-select').value;
        maxRounds = parseInt(document.getElementById('length-select').value);
        peer = new Peer(Math.floor(1000 + Math.random() * 9000).toString());
        myRole = 'host';
        peer.on('open', (id) => { document.getElementById('my-id-display').innerText = id; show('screen-waiting'); });
        peer.on('connection', (c) => { conn = c; setupConn(); });
    }

    function startJoin() {
        const tid = document.getElementById('join-id').value;
        peer = new Peer(); myRole = 'guest';
        peer.on('open', () => { conn = peer.connect(tid); setupConn(); });
    }

    function setupConn() {
        conn.on('open', () => { 
            if(myRole==='host') conn.send({type:'INIT', mode, maxRounds});
            show('screen-game'); startRound(); 
        });
        conn.on('data', (d) => {
            if(d.type==='INIT') { mode = d.mode; maxRounds = d.maxRounds; startRound(); }
            if(d.type==='TRUTH') { truth = d.order; updateUI(); }
            if(d.type==='GUESS') { revealAll(truth, d.order); }
            if(d.type==='NEXT') { currentIdx++; startRound(); }
        });
    }

    function startRound() {
        if (currentIdx >= maxRounds) { showFinalScore(); return; }
        show('screen-game'); truth = null; locked = false;
        
        const qSet = questionBank[mode];
        const q = qSet[currentIdx % qSet.length];
        document.getElementById('question-text').innerText = q.q;
        document.getElementById('round-counter').innerText = `Round ${currentIdx + 1} of ${maxRounds}`;
        
        renderList(q.opts);
        updateUI();
    }

    function updateUI() {
        const roleEl = document.getElementById('role-indicator');
        const btn = document.getElementById('submit-btn');
        // Role swaps every round
        const isChooser = (currentIdx % 2 === 0 && myRole === 'host') || (currentIdx % 2 !== 0 && myRole === 'guest');

        if(isChooser) {
            roleEl.innerText = "YOUR ROLE: CHOOSER (Setting the Truth)";
            roleEl.className = "role-banner role-chooser";
            btn.classList.remove('hidden');
        } else if (!truth) {
            roleEl.innerText = "YOUR ROLE: GUESSER (Wait for Partner)";
            roleEl.className = "role-banner role-guesser";
            btn.classList.add('hidden');
        } else {
            roleEl.innerText = "YOUR ROLE: GUESSER (Guess the Truth!)";
            roleEl.className = "role-banner role-guesser";
            btn.classList.remove('hidden');
        }

        if (locked) { btn.innerText = "✓ ORDER LOCKED"; btn.className = "btn-main btn-locked"; }
        else { btn.innerText = "LOCK MY ORDER"; btn.className = "btn-main"; }
    }

    function sendOrder() {
        const order = [...document.querySelectorAll('.rank-item')].map(li => li.innerText);
        locked = true; updateUI();
        if(!truth) { conn.send({type:'TRUTH', order}); truth = order; }
        else { conn.send({type:'GUESS', order}); revealAll(truth, order); }
    }

    function revealAll(truthArr, guessArr) {
        show('screen-results');
        const stack = document.getElementById('full-reveal');
        stack.innerHTML = "";
        let pts = 0;

        truthArr.forEach((item, i) => {
            const gIdx = guessArr.indexOf(item);
            const dist = Math.abs(i - gIdx);
            if(dist === 0) pts += 2; else if(dist === 1) pts += 1;
            const div = document.createElement('div');
            div.className = `res-item ${dist === 0 ? 'perfect' : (dist === 1 ? 'close' : '')}`;
            div.innerHTML = `<div class="res-rank">#${i + 1}</div><div class="res-content"><b>${item}</b><br><small>Partner guessed #${gIdx+1}</small></div>`;
            stack.appendChild(div);
        });
        
        const roundScore = Math.round((pts/10)*100);
        totalScore += roundScore;
        document.getElementById('score-display').innerText = roundScore + "%";
        
        // Host gets the control button, Guest gets the wait label
        const hostControls = document.getElementById('host-controls');
        if (myRole === 'host') {
            hostControls.innerHTML = `<button class="btn-main" onclick="hostProceed()">${currentIdx + 1 >= maxRounds ? 'See Final Summary' : 'Next Question →'}</button>`;
        } else {
            hostControls.innerHTML = `<button class="btn-wait" disabled>Waiting for Host...</button>`;
        }
    }

    function hostProceed() {
        if (currentIdx + 1 >= maxRounds) {
            showFinalScore();
            conn.send({type: 'NEXT'}); // Moves guest to final screen
        } else {
            currentIdx++;
            conn.send({type: 'NEXT'});
            startRound();
        }
    }

    function showFinalScore() {
        show('screen-final');
        document.getElementById('final-score').innerText = Math.round(totalScore / maxRounds) + "%";
    }

    function renderList(opts) {
        const list = document.getElementById('rank-list');
        list.innerHTML = "";
        opts.sort(()=>Math.random()-0.5).forEach(t => {
            const li = document.createElement('div');
            li.className = 'rank-item'; li.draggable = true; li.innerText = t;
            li.addEventListener('dragstart', () => { if(!locked) li.classList.add('dragging') });
            li.addEventListener('dragend', () => li.classList.remove('dragging'));
            list.appendChild(li);
        });
    }

    document.getElementById('rank-list').addEventListener('dragover', e => {
        if(locked) return;
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        const list = document.getElementById('rank-list');
        const after = [...list.querySelectorAll('.rank-item:not(.dragging)')].find(el => e.clientY <= el.getBoundingClientRect().top + el.height/2);
        list.insertBefore(dragging, after || null);
    });

    function show(id) { document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
</script>
</body>
</html>
