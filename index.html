<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoRanker - Detailed Results</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p1: #6366f1; --p2: #ec4899; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #22c55e; --near: #eab308; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 1rem; min-height: 100vh; margin: 0; }
        .container { max-width: 480px; width: 100%; background: var(--card); padding: 1.5rem; border-radius: 28px; text-align: center; align-self: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        /* The Result Card */
        .comparison-stack { margin-top: 20px; display: flex; flex-direction: column; gap: 8px; }
        .res-item { display: flex; align-items: center; background: #0f172a; padding: 12px 16px; border-radius: 16px; border-left: 5px solid #475569; transition: 0.3s; }
        
        /* Status Colors */
        .res-item.perfect { border-left-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .res-item.close { border-left-color: var(--near); background: rgba(234, 179, 8, 0.1); }

        .res-rank { font-weight: 800; font-size: 1.2rem; min-width: 30px; color: #94a3b8; }
        .res-content { flex-grow: 1; text-align: left; padding: 0 15px; }
        .res-name { font-weight: 600; display: block; font-size: 0.95rem; }
        .res-sub { font-size: 0.75rem; color: #64748b; }
        
        .res-diff { font-size: 0.75rem; font-weight: bold; background: #334155; padding: 4px 8px; border-radius: 8px; }
        .perfect .res-diff { background: var(--success); color: white; }

        /* General UI */
        #rank-list { list-style: none; padding: 0; margin: 1.5rem 0; }
        .rank-item { background: #334155; margin-bottom: 10px; padding: 1rem; border-radius: 14px; cursor: grab; display: flex; align-items: center; border: 2px solid transparent; }
        .rank-item.dragging { opacity: 0.4; border-color: var(--p1); }
        button { width: 100%; padding: 1.1rem; border-radius: 14px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .btn-main { background: var(--p1); color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-start">
        <h1>DuoRanker</h1>
        <button class="btn-main" onclick="startHost()">Host Game</button>
        <input type="text" id="join-id" placeholder="Code" style="width: 50%; margin: 10px; padding: 10px; border-radius: 8px; border: none;">
        <button onclick="startJoin()">Join Game</button>
    </div>

    <div id="screen-waiting" class="hidden">
        <h3>Invite Code</h3>
        <h1 id="my-id-display" style="color: var(--p1); font-size: 3rem;">----</h1>
    </div>

    <div id="screen-game" class="hidden">
        <h2 id="question-text">...</h2>
        <div id="rank-list"></div>
        <button id="submit-btn" class="btn-main" onclick="sendOrder()">Lock My Ranking</button>
    </div>

    <div id="screen-results" class="hidden">
        <h3 id="result-header" style="color: #94a3b8; margin: 0;">Match Strength</h3>
        <div id="score-display" style="font-size: 4rem; font-weight: 900; color: var(--p2); margin-bottom: 10px;">0%</div>
        
        <div class="comparison-stack" id="full-reveal">
            </div>
        
        <button class="btn-main" onclick="nextRound()" style="margin-top: 20px;">Next Question →</button>
    </div>
</div>

<script>
    // Example Bank
    const questions = [
        { q: "Best Pizza Topping?", opts: ["Pepperoni", "Mushrooms", "Extra Cheese", "Pineapple", "Onions"] },
        { q: "Ideal Superpower?", opts: ["Flight", "Teleportation", "Mind Reading", "Invisibility", "Time Travel"] }
    ];

    let peer, conn, myRole, truth, currentIdx = 0, locked = false;

    // --- Peer Setup ---
    function startHost() {
        const id = Math.floor(1000 + Math.random() * 9000).toString();
        peer = new Peer(id); myRole = 'host';
        peer.on('open', (i) => { document.getElementById('my-id-display').innerText = i; show('screen-waiting'); });
        peer.on('connection', (c) => { conn = c; handleConn(); });
    }
    function startJoin() {
        const tid = document.getElementById('join-id').value;
        peer = new Peer(); myRole = 'guest';
        peer.on('open', () => { conn = peer.connect(tid); handleConn(); });
    }
    function handleConn() {
        conn.on('open', () => { show('screen-game'); startRound(); });
        conn.on('data', (d) => {
            if(d.type==='TRUTH') { truth = d.order; updateUI(); }
            if(d.type==='GUESS') { revealAll(truth, d.order); }
            if(d.type==='NEXT') { currentIdx++; startRound(); }
        });
    }

    // --- Game Logic ---
    function startRound() {
        show('screen-game'); truth = null; locked = false;
        const q = questions[currentIdx % questions.length];
        document.getElementById('question-text').innerText = q.q;
        renderList(q.opts);
        updateUI();
    }

    function updateUI() {
        const isTurn = (currentIdx % 2 === 0 && myRole === 'host') || (currentIdx % 2 !== 0 && myRole === 'guest');
        const btn = document.getElementById('submit-btn');
        if (locked) { btn.innerText = "Locked In..."; btn.disabled = true; }
        else { btn.innerText = "Lock My Ranking"; btn.disabled = false; }
    }

    function sendOrder() {
        const order = [...document.querySelectorAll('.rank-item')].map(li => li.innerText);
        locked = true; updateUI();
        if(!truth) { conn.send({type:'TRUTH', order}); truth = order; }
        else { conn.send({type:'GUESS', order}); revealAll(truth, order); }
    }

    function revealAll(truthArr, guessArr) {
        show('screen-results');
        const stack = document.getElementById('full-reveal');
        stack.innerHTML = "";
        let pts = 0;

        // Reveal each of the 5 options based on Truth Order
        truthArr.forEach((item, i) => {
            const guessPos = guessArr.indexOf(item);
            const dist = Math.abs(i - guessPos);
            
            if(dist === 0) pts += 2;
            else if(dist === 1) pts += 1;

            const div = document.createElement('div');
            div.className = `res-item ${dist === 0 ? 'perfect' : (dist === 1 ? 'close' : '')}`;
            
            div.innerHTML = `
                <div class="res-rank">#${i + 1}</div>
                <div class="res-content">
                    <span class="res-name">${item}</span>
                    <span class="res-sub">Guessed at: #${guessPos + 1}</span>
                </div>
                <div class="res-diff">${dist === 0 ? 'MATCH' : '±' + dist}</div>
            `;
            stack.appendChild(div);
        });

        const score = Math.round((pts / (truthArr.length * 2)) * 100);
        document.getElementById('score-display').innerText = score + "%";
    }

    // --- Drag Logic ---
    function renderList(opts) {
        const list = document.getElementById('rank-list');
        list.innerHTML = "";
        opts.sort(()=>Math.random()-0.5).forEach(t => {
            const li = document.createElement('div');
            li.className = 'rank-item'; li.draggable = true; li.innerText = t;
            li.addEventListener('dragstart', () => li.classList.add('dragging'));
            li.addEventListener('dragend', () => li.classList.remove('dragging'));
            list.appendChild(li);
        });
    }

    document.getElementById('rank-list').addEventListener('dragover', e => {
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        const list = document.getElementById('rank-list');
        const after = [...list.querySelectorAll('.rank-item:not(.dragging)')].find(el => e.clientY <= el.getBoundingClientRect().top + el.height/2);
        list.insertBefore(dragging, after || null);
    });

    function nextRound() { currentIdx++; conn.send({type:'NEXT'}); startRound(); }
    function show(id) { document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
</script>
</body>
</html>
