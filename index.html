<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DuoRanker - Synced Multiplayer</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
:root { --p1:#6366f1; --p2:#ec4899; --bg:#0f172a; --card:#1e293b; --text:#f8fafc; --success:#22c55e; --near:#eab308; }

body{
font-family:'Segoe UI',system-ui;
background:var(--bg);
color:var(--text);
display:flex;
justify-content:center;
padding:1rem;
min-height:100vh;
margin:0;
}

.container{
max-width:480px;
width:100%;
background:var(--card);
padding:1.5rem;
border-radius:28px;
text-align:center;
align-self:center;
box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);
}

.role-banner{
padding:10px;
border-radius:12px;
font-size:.85rem;
font-weight:800;
text-transform:uppercase;
margin-bottom:15px;
}

.role-chooser{background:rgba(236,72,153,.1);border:1px solid var(--p2);color:var(--p2);}
.role-guesser{background:rgba(99,102,241,.1);border:1px solid var(--p1);color:var(--p1);}

.rank-item{
background:#334155;
margin-bottom:10px;
padding:1rem;
border-radius:14px;
cursor:grab;
display:flex;
align-items:center;
text-align:left;
font-size:.95rem;
}

.rank-item.dragging{opacity:.4;}

button{
width:100%;
padding:1.1rem;
border-radius:14px;
border:none;
font-weight:bold;
cursor:pointer;
font-size:1rem;
margin-top:10px;
}

.btn-main{background:var(--p1);color:white;}
.btn-wait{background:#0f172a;color:#475569;border:1px solid #334155;cursor:not-allowed;}

select,input{
width:100%;
padding:12px;
border-radius:12px;
background:#0f172a;
color:white;
border:1px solid #475569;
margin-bottom:15px;
box-sizing:border-box;
}

.hidden{display:none;}

.fade-in{animation:fadeIn .25s ease-in-out;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>

<body>

<div class="container">

<div id="connection-status" style="font-size:.8rem;color:#eab308;margin-bottom:8px;">
Disconnected
</div>

<div id="screen-start">
<h1>DuoRanker</h1>

<select id="mode-select">
<option value="romance">Romance</option>
<option value="personal">Personal</option>
</select>

<select id="length-select">
<option value="10">10 Questions</option>
<option value="20">20 Questions</option>
<option value="30">30 Questions</option>
</select>

<button class="btn-main" onclick="startHost()">Host Game</button>

<div style="margin:15px;color:#475569;">— OR —</div>

<input type="text" id="join-id" placeholder="Code">
<button style="background:#334155;color:white;" onclick="startJoin()">Join Partner</button>
</div>

<div id="screen-waiting" class="hidden">
<h3>Room Code</h3>
<h1 id="my-id-display" style="font-size:3.5rem;color:var(--p1);margin:0;">----</h1>
</div>

<div id="screen-game" class="hidden">
<div id="role-indicator" class="role-banner">Role</div>
<div id="timer" style="font-size:1.2rem;font-weight:bold;color:#eab308;">20s</div>
<h2 id="question-text">...</h2>
<div id="rank-list"></div>
<button id="submit-btn" class="btn-main" onclick="sendOrder()">Lock Order</button>
<p id="round-counter" style="font-size:.8rem;color:#64748b;"></p>
</div>

<div id="screen-results" class="hidden">
<h2 id="score-display">0%</h2>
<div id="host-control-area"></div>
</div>

<div id="screen-final" class="hidden">
<h1>Game Over</h1>
<h1 id="final-score">0%</h1>
<button class="btn-main" onclick="location.reload()">Home</button>
</div>

</div>

<audio id="click-sfx" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="score-sfx" src="https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg"></audio>

<script>
/* ---------- QUESTION BANK ---------- */

const questionBank={
romance:[
{q:"Ideal First Date?",opts:["Dinner","Coffee","Arcade","Picnic","Movie"]},
{q:"Best Gesture?",opts:["Letter","Trip","Cooking","Gifts","Hug"]}
],
personal:[
{q:"Life Phase?",opts:["Childhood","Teen","Adult","Career","Retirement"]},
{q:"Biggest Fear?",opts:["Failure","Alone","Pain","Crowd","Loss"]}
]
};

/* ---------- GLOBAL STATE ---------- */

let peer,conn,myRole;
let currentIdx=0,mode="romance",maxRounds=10;
let truth=null,locked=false,totalScore=0;
let reconnectAttempts=0;
let roundTimer=null,timeLeft=20,paused=false;

/* ---------- AUDIO ---------- */

function playSound(id){
const s=document.getElementById(id);
if(s){s.currentTime=0;s.play();}
}

/* ---------- NETWORK ---------- */

function startHost(){
mode=document.getElementById("mode-select").value;
maxRounds=parseInt(document.getElementById("length-select").value);

peer=new Peer(Math.floor(1000+Math.random()*9000).toString());
myRole="host";

peer.on("open",id=>{
document.getElementById("my-id-display").innerText=id;
show("screen-waiting");
});

peer.on("connection",c=>{
conn=c;
setupConn();
});
}

function startJoin(){
peer=new Peer();
myRole="guest";

peer.on("open",()=>{
conn=peer.connect(document.getElementById("join-id").value);
setupConn();
});
}

function setupConn(){

conn.on("open",()=>{
updateStatus("Connected");

if(myRole==="host"){
conn.send({type:"INIT",mode,maxRounds});
sendGameState();
show("screen-game");
startRound();
}
});

conn.on("close",handleDisconnect);
conn.on("error",handleDisconnect);

conn.on("data",d=>{

if(d.type==="INIT"){
mode=d.mode;
maxRounds=d.maxRounds;
}

if(d.type==="SYNC"){
Object.assign(window,d.state);
startRound();
startTimer();
}

if(d.type==="TRUTH"){truth=d.order;updateUI();}
if(d.type==="GUESS"){revealAll(truth,d.order);}

if(d.type==="NEXT"){
currentIdx=d.index;
if(currentIdx>=maxRounds)showFinalScore();
else startRound();
}

if(d.type==="PAUSE"){
paused=d.paused;
if(!paused)startTimer();
}

});
}

function handleDisconnect(){
updateStatus("Reconnecting...");
if(myRole==="guest"&&reconnectAttempts<5){
reconnectAttempts++;
setTimeout(startJoin,1500);
}
}

function sendGameState(){
if(myRole!=="host")return;

conn.send({
type:"SYNC",
state:{
currentIdx,
mode,
maxRounds,
truth,
paused,
timeLeft
}
});
}

/* ---------- GAME FLOW ---------- */

function startRound(){
if(currentIdx>=maxRounds)return;

truth=null;
locked=false;
timeLeft=20;

const qSet=questionBank[mode];
const q=qSet[currentIdx%qSet.length];

document.getElementById("question-text").innerText=q.q;
document.getElementById("round-counter").innerText=
`Round ${currentIdx+1} / ${maxRounds}`;

renderList(q.opts);
updateUI();
startTimer();
}

function updateUI(){

const role=document.getElementById("role-indicator");
const btn=document.getElementById("submit-btn");

const chooser=
(currentIdx%2===0&&myRole==="host")||
(currentIdx%2!==0&&myRole==="guest");

if(chooser){
role.innerText="Chooser";
role.className="role-banner role-chooser";
btn.classList.remove("hidden");
}
else if(!truth){
role.innerText="Waiting...";
role.className="role-banner role-guesser";
btn.classList.add("hidden");
}
else{
role.innerText="Guess Now";
role.className="role-banner role-guesser";
btn.classList.remove("hidden");
}

btn.disabled=locked;
}

function sendOrder(){

playSound("click-sfx");

const order=[...document.querySelectorAll(".rank-item")]
.map(li=>li.innerText);

locked=true;
updateUI();

if(!truth){
truth=order;
conn.send({type:"TRUTH",order});
}
else{
conn.send({type:"GUESS",order});
revealAll(truth,order);
}
}

function revealAll(truthArr,guessArr){

show("screen-results");
playSound("score-sfx");

let pts=0;

truthArr.forEach((item,i)=>{
const g=guessArr.indexOf(item);
const d=Math.abs(i-g);
if(d===0)pts+=2;
else if(d===1)pts+=1;
});

const score=Math.round((pts/10)*100);
totalScore+=score;
document.getElementById("score-display").innerText=score+"%";

const area=document.getElementById("host-control-area");

if(myRole==="host"){
area.innerHTML=`
<button class="btn-main" onclick="togglePause()">
${paused?"Resume ▶":"Pause ⏸"}
</button>
<button class="btn-main" onclick="triggerHostNext()">
${currentIdx+1>=maxRounds?"Finish":"Next →"}
</button>`;
}
else{
area.innerHTML=`<button class="btn-wait">Waiting for Host...</button>`;
}
}

function triggerHostNext(){
if(myRole!=="host")return;

const next=currentIdx+1;
currentIdx=next;

conn.send({type:"NEXT",index:next});

if(next>=maxRounds)showFinalScore();
else startRound();
}

function togglePause(){
if(myRole!=="host")return;

paused=!paused;
conn.send({type:"PAUSE",paused});
if(!paused)startTimer();
}

function showFinalScore(){
show("screen-final");
document.getElementById("final-score").innerText=
Math.round(totalScore/maxRounds)+"%";
}

/* ---------- TIMER ---------- */

function startTimer(){
clearInterval(roundTimer);
document.getElementById("timer").innerText=timeLeft+"s";

roundTimer=setInterval(()=>{
if(paused)return;

timeLeft--;
document.getElementById("timer").innerText=timeLeft+"s";

if(timeLeft<=0){
clearInterval(roundTimer);
if(!locked)sendOrder();
}
},1000);
}

/* ---------- DRAG SORT ---------- */

function renderList(opts){
const list=document.getElementById("rank-list");
list.innerHTML="";

opts.sort(()=>Math.random()-.5).forEach(t=>{
const li=document.createElement("div");
li.className="rank-item fade-in";
li.draggable=true;
li.innerText=t;

li.addEventListener("dragstart",()=>!locked&&li.classList.add("dragging"));
li.addEventListener("dragend",()=>li.classList.remove("dragging"));

list.appendChild(li);
});
}

document.getElementById("rank-list").addEventListener("dragover",e=>{
if(locked)return;
e.preventDefault();

const dragging=document.querySelector(".dragging");
const list=document.getElementById("rank-list");

const after=[...list.querySelectorAll(".rank-item:not(.dragging)")]
.find(el=>e.clientY<=el.getBoundingClientRect().top+el.height/2);

list.insertBefore(dragging,after||null);
});

/* ---------- UI HELPERS ---------- */

function show(id){
document.querySelectorAll(".container>div")
.forEach(d=>d.classList.add("hidden"));

const el=document.getElementById(id);
el.classList.remove("hidden");
el.classList.add("fade-in");
}

function updateStatus(text){
document.getElementById("connection-status").innerText=text;
}
</script>

</body>
</html>
